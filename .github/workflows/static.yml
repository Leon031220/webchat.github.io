<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebChat Pro - Enterprise Messaging</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <style>
        /* ===== RESET & BASE STYLES ===== */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
        }
        
        body { 
            background: #0d1520; 
            color: #e4e6eb; 
            overflow: hidden;
            font-size: 14px;
            line-height: 1.5;
        }
        
        a { color: #00a884; text-decoration: none; }
        a:hover { text-decoration: underline; }
        
        button { cursor: pointer; border: none; outline: none; }
        input, textarea { outline: none; }
        
        /* ===== ANIMATIONS ===== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); }
            to { transform: translateX(-100%); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
            30% { transform: translateY(-5px); opacity: 1; }
        }
        
        @keyframes recording {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* ===== UTILITY CLASSES ===== */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-center { display: flex; align-items: center; justify-content: center; }
        .flex-col { display: flex; flex-direction: column; }
        .flex-1 { flex: 1; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .gap-4 { gap: 16px; }
        .gap-5 { gap: 20px; }
        .p-3 { padding: 12px; }
        .p-4 { padding: 16px; }
        .p-5 { padding: 20px; }
        .m-3 { margin: 12px; }
        .m-4 { margin: 16px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 12px; }
        .mb-4 { margin-bottom: 16px; }
        .mt-2 { margin-top: 8px; }
        .mt-3 { margin-top: 12px; }
        .mt-4 { margin-top: 16px; }
        .text-center { text-align: center; }
        .text-sm { font-size: 12px; }
        .text-lg { font-size: 16px; }
        .text-xl { font-size: 18px; }
        .font-semibold { font-weight: 600; }
        .rounded { border-radius: 8px; }
        .rounded-lg { border-radius: 12px; }
        .rounded-full { border-radius: 9999px; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .overflow-hidden { overflow: hidden; }
        .overflow-auto { overflow: auto; }
        .transition { transition: all 0.3s ease; }
        .cursor-pointer { cursor: pointer; }
        .select-none { user-select: none; }
        .backdrop-blur { backdrop-filter: blur(10px); }
        
        /* ===== LAYOUT STRUCTURE ===== */
        #app {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0d1520;
        }
        
        .container {
            display: flex;
            width: 100%;
            height: 100%;
            background: #111b21;
            position: relative;
        }
        
        /* ===== LOGIN SCREEN ===== */
        #loginScreen {
            background: linear-gradient(135deg, #0d1520 0%, #1a2533 100%);
            animation: fadeIn 0.5s ease;
        }
        
        .login-card {
            background: #202c33;
            border-radius: 16px;
            padding: 40px;
            width: 90%;
            max-width: 440px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            border: 1px solid #2a3942;
            animation: fadeIn 0.8s ease;
        }
        
        .logo-container {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .logo {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #00a884, #25d366);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        
        .tagline {
            color: #8696a0;
            font-size: 14px;
        }
        
        .input-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #8696a0;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 16px 14px 48px;
            background: #111b21;
            border: 1px solid #2a3942;
            color: #fff;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            border-color: #00a884;
            box-shadow: 0 0 0 3px rgba(0, 168, 132, 0.2);
        }
        
        .form-input::placeholder {
            color: #8696a0;
        }
        
        .btn {
            padding: 14px 24px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00a884, #25d366);
            color: white;
            width: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 168, 132, 0.3);
        }
        
        .btn-secondary {
            background: #2a3942;
            color: #e4e6eb;
            border: 1px solid #374750;
        }
        
        .btn-secondary:hover {
            background: #374750;
        }
        
        .btn-danger {
            background: #ff3b30;
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff5e55;
        }
        
        .btn-ghost {
            background: transparent;
            color: #aebac1;
            border: 1px solid transparent;
        }
        
        .btn-ghost:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: #374750;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            color: #aebac1;
            font-size: 14px;
            cursor: pointer;
        }
        
        .checkbox-label input {
            margin-right: 8px;
            accent-color: #00a884;
        }
        
        .quick-users {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 24px 0;
        }
        
        .quick-user-btn {
            padding: 12px 8px;
            background: #2a3942;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .quick-user-btn:hover {
            background: #374750;
            border-color: #00a884;
            transform: translateY(-2px);
        }
        
        .user-avatar-small {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        
        .error-message {
            color: #ff3b30;
            font-size: 13px;
            text-align: center;
            min-height: 20px;
            margin-top: 12px;
        }
        
        /* ===== MAIN APP LAYOUT ===== */
        #mainScreen {
            display: none;
        }
        
        /* Sidebar */
        .sidebar {
            width: 380px;
            min-width: 380px;
            background: #111b21;
            border-right: 1px solid #2a3942;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 100;
        }
        
        .sidebar-header {
            padding: 16px;
            background: #202c33;
            border-bottom: 1px solid #2a3942;
            min-height: 72px;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 10px;
            transition: background 0.2s;
            cursor: pointer;
        }
        
        .user-profile:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00a884, #25d366);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            background-size: cover;
            background-position: center;
            border: 2px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }
        
        .user-info {
            flex: 1;
            min-width: 0;
        }
        
        .user-name {
            font-size: 16px;
            font-weight: 600;
            color: #e4e6eb;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #00a884;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: #00a884;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .header-actions {
            display: flex;
            gap: 8px;
        }
        
        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #2a3942;
            color: #aebac1;
            transition: all 0.2s ease;
            font-size: 16px;
        }
        
        .icon-btn:hover {
            background: #374750;
            color: #fff;
            transform: translateY(-1px);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            background: #202c33;
            border-bottom: 1px solid #2a3942;
            padding: 0 12px;
        }
        
        .tab {
            flex: 1;
            padding: 16px 12px;
            background: none;
            color: #8696a0;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            transition: all 0.3s ease;
            border-radius: 6px 6px 0 0;
            margin: 0 2px;
        }
        
        .tab:hover {
            color: #d1d7db;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .tab.active {
            color: #00a884;
            background: rgba(0, 168, 132, 0.1);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: #00a884;
            border-radius: 3px 3px 0 0;
        }
        
        /* Search */
        .search-container {
            padding: 16px;
            position: sticky;
            top: 0;
            background: #111b21;
            z-index: 10;
            border-bottom: 1px solid #2a3942;
        }
        
        .search-box {
            display: flex;
            align-items: center;
            background: #202c33;
            border-radius: 20px;
            padding: 10px 16px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        
        .search-box:focus-within {
            border-color: #00a884;
            background: #1a2529;
            box-shadow: 0 2px 8px rgba(0, 168, 132, 0.1);
        }
        
        .search-input {
            border: none;
            background: none;
            color: #fff;
            width: 100%;
            margin-left: 10px;
            font-size: 14px;
        }
        
        /* Tab Content */
        .tab-content {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }
        
        .tab-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .tab-content::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .tab-content::-webkit-scrollbar-thumb {
            background: #2a3942;
            border-radius: 3px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #8696a0;
        }
        
        .empty-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        /* Chat List */
        .chat-list {
            padding: 0;
        }
        
        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #2a3942;
            transition: background 0.2s;
            cursor: pointer;
            position: relative;
        }
        
        .chat-item:hover {
            background: #202c33;
        }
        
        .chat-item.active {
            background: #2a3942;
            border-left: 3px solid #00a884;
        }
        
        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            margin-right: 12px;
            flex-shrink: 0;
            border: 2px solid transparent;
            transition: transform 0.2s;
            background-size: cover;
            background-position: center;
        }
        
        .chat-item:hover .chat-avatar {
            transform: scale(1.05);
        }
        
        .chat-info {
            flex: 1;
            min-width: 0;
        }
        
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .chat-name {
            font-weight: 600;
            color: #e4e6eb;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-time {
            font-size: 11px;
            color: #8696a0;
            flex-shrink: 0;
        }
        
        .chat-preview {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-message {
            font-size: 13px;
            color: #8696a0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            margin-right: 10px;
        }
        
        .unread-badge {
            background: #00a884;
            color: white;
            border-radius: 10px;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            padding: 0 6px;
            flex-shrink: 0;
        }
        
        /* Main Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0c1317;
            position: relative;
            min-width: 0;
        }
        
        .chat-header-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: #202c33;
            border-bottom: 1px solid #2a3942;
            min-height: 72px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .contact-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }
        
        .contact-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff416c, #ff4b2b);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
        }
        
        .contact-details {
            flex: 1;
            min-width: 0;
        }
        
        .contact-name {
            font-size: 16px;
            font-weight: 600;
            color: #e4e6eb;
            margin-bottom: 4px;
        }
        
        .contact-status {
            font-size: 13px;
            color: #8696a0;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .chat-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        /* Messages Area */
        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background: #0c1317;
            position: relative;
        }
        
        .messages-scroll {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: min-content;
        }
        
        /* Message Bubbles */
        .message {
            max-width: 65%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            margin-bottom: 4px;
        }
        
        .message-out {
            align-self: flex-end;
            background: linear-gradient(135deg, #005c4b, #008069);
            color: #ffffff;
            border-radius: 18px 4px 18px 18px;
            margin-left: auto;
        }
        
        .message-in {
            align-self: flex-start;
            background: #202c33;
            color: #e4e6eb;
            border-radius: 4px 18px 18px 18px;
        }
        
        .message-system {
            align-self: center;
            background: rgba(42, 57, 66, 0.6);
            color: #8696a0;
            font-size: 12px;
            padding: 10px 16px;
            margin: 12px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .message-date {
            text-align: center;
            color: #8696a0;
            font-size: 12px;
            margin: 20px 0;
            position: relative;
        }
        
        .message-date::before,
        .message-date::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 30%;
            height: 1px;
            background: #2a3942;
        }
        
        .message-date::before {
            left: 0;
        }
        
        .message-date::after {
            right: 0;
        }
        
        .message-sender {
            font-size: 12px;
            color: #8696a0;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .message-content {
            line-height: 1.5;
        }
        
        .message-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
            font-size: 11px;
        }
        
        .message-time {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .message-status {
            margin-left: 4px;
        }
        
        /* Message Types */
        .message-image {
            max-width: 280px;
            max-height: 280px;
            border-radius: 12px;
            margin: 8px 0;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .message-image:hover {
            transform: scale(1.02);
        }
        
        .message-file {
            background: #2a3942;
            padding: 12px;
            border-radius: 12px;
            margin: 8px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .message-file:hover {
            background: #374750;
        }
        
        .file-icon {
            font-size: 24px;
            margin-right: 12px;
            color: #00a884;
        }
        
        .file-info {
            flex: 1;
            min-width: 0;
        }
        
        .file-name {
            font-weight: 600;
            color: #e4e6eb;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-size {
            font-size: 12px;
            color: #8696a0;
        }
        
        .audio-message {
            width: 250px;
            background: #2a3942;
            border-radius: 12px;
            padding: 12px;
        }
        
        .audio-player {
            width: 100%;
            height: 36px;
            border-radius: 18px;
            background: #111b21;
            border: 1px solid #374750;
        }
        
        .audio-player::-webkit-media-controls-panel {
            background: #111b21;
            border-radius: 18px;
        }
        
        .audio-player::-webkit-media-controls-play-button {
            background-color: #00a884;
            border-radius: 50%;
        }
        
        /* Polls */
        .poll-container {
            background: #2a3942;
            padding: 16px;
            border-radius: 12px;
            margin: 8px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 250px;
        }
        
        .poll-question {
            font-weight: 600;
            margin-bottom: 16px;
            color: #e4e6eb;
            font-size: 14px;
        }
        
        .poll-option {
            background: #111b21;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }
        
        .poll-option:hover {
            background: #1a2529;
            border-color: #00a884;
        }
        
        .poll-option.selected {
            border-color: #00a884;
            background: rgba(0, 168, 132, 0.1);
        }
        
        .poll-option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .poll-text {
            flex: 1;
        }
        
        .poll-percentage {
            font-weight: bold;
            color: #00a884;
            margin-left: 8px;
        }
        
        .poll-votes {
            font-size: 11px;
            color: #8696a0;
        }
        
        .poll-bar-container {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 6px;
        }
        
        .poll-bar {
            height: 100%;
            background: linear-gradient(90deg, #00a884, #25d366);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .poll-footer {
            font-size: 12px;
            color: #8696a0;
            margin-top: 12px;
            display: flex;
            justify-content: space-between;
        }
        
        /* Input Area */
        .input-area {
            display: flex;
            align-items: flex-end;
            padding: 16px 20px;
            background: #202c33;
            border-top: 1px solid #2a3942;
            min-height: 72px;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        
        .input-tools {
            display: flex;
            gap: 8px;
            margin-right: 12px;
            align-items: center;
        }
        
        .tool-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #2a3942;
            color: #aebac1;
            transition: all 0.2s ease;
            font-size: 18px;
        }
        
        .tool-btn:hover {
            background: #374750;
            color: #fff;
            transform: translateY(-2px);
        }
        
        .tool-btn.recording {
            background: #ff3b30;
            color: white;
            animation: recording 1s infinite;
        }
        
        .message-input-container {
            flex: 1;
            display: flex;
            align-items: flex-end;
            background: #2a3942;
            border-radius: 24px;
            padding: 8px 16px;
            min-height: 44px;
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }
        
        .message-input-container:focus-within {
            border-color: #00a884;
            background: #1a2529;
            box-shadow: 0 2px 8px rgba(0, 168, 132, 0.1);
        }
        
        .message-input {
            flex: 1;
            background: none;
            border: none;
            color: #fff;
            font-size: 15px;
            resize: none;
            max-height: 120px;
            min-height: 24px;
            line-height: 1.5;
            font-family: inherit;
        }
        
        .message-input::placeholder {
            color: #8696a0;
        }
        
        .send-btn {
            background: linear-gradient(135deg, #00a884, #25d366);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin-left: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            transition: all 0.3s ease;
            flex-shrink: 0;
            box-shadow: 0 4px 15px rgba(0, 168, 132, 0.3);
        }
        
        .send-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 168, 132, 0.4);
        }
        
        .send-btn:disabled {
            background: #2a3942;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            color: #8696a0;
            font-size: 13px;
            padding: 8px 16px;
            background: rgba(32, 44, 51, 0.8);
            border-radius: 18px;
            margin: 4px 0;
            align-self: flex-start;
            max-width: fit-content;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .typing-dots {
            display: flex;
            margin-left: 8px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background: #8696a0;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        /* ===== WEBRTC CALL INTERFACE ===== */
        .call-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0d1520;
            z-index: 10000;
            display: none;
            flex-direction: column;
        }
        
        .call-header {
            padding: 20px;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }
        
        .call-info {
            text-align: center;
            flex: 1;
        }
        
        .call-title {
            font-size: 20px;
            font-weight: 600;
            color: white;
            margin-bottom: 6px;
        }
        
        .call-status {
            color: #00a884;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .call-duration {
            color: #8696a0;
            font-size: 14px;
        }
        
        .video-container {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            padding: 20px;
        }
        
        .remote-video-container {
            width: 100%;
            height: 100%;
            max-width: 1200px;
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .local-video-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 180px;
            height: 135px;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }
        
        .local-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        
        .call-controls {
            padding: 24px 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .call-control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 22px;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: white;
            background: rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .call-control-btn:hover {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .call-control-btn.active {
            background: rgba(0, 168, 132, 0.3);
            border-color: #00a884;
        }
        
        .call-control-btn.muted {
            background: rgba(255, 59, 48, 0.3);
            border-color: #ff3b30;
        }
        
        .call-control-btn.end-call {
            background: #ff3b30;
            border-color: #ff3b30;
            width: 70px;
            height: 70px;
        }
        
        .call-control-btn.end-call:hover {
            background: #ff5e55;
            border-color: #ff5e55;
            transform: scale(1.15);
        }
        
        .call-control-btn.recording {
            background: rgba(255, 59, 48, 0.3);
            border-color: #ff3b30;
            animation: pulse 1s infinite;
        }
        
        .call-control-btn.recording::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ff3b30;
            border-radius: 50%;
            top: 8px;
            right: 8px;
        }
        
        /* ===== MODALS ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 20000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: #202c33;
            border-radius: 16px;
            padding: 32px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #2a3942;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.4s ease;
        }
        
        .modal-header {
            margin-bottom: 24px;
            text-align: center;
        }
        
        .modal-title {
            font-size: 22px;
            font-weight: 600;
            color: #00a884;
            margin-bottom: 8px;
        }
        
        .modal-subtitle {
            color: #8696a0;
            font-size: 14px;
        }
        
        .modal-body {
            margin-bottom: 24px;
        }
        
        .modal-footer {
            display: flex;
            gap: 12px;
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #2a3942;
            color: #aebac1;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-close:hover {
            background: #374750;
            color: #fff;
        }
        
        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 30000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }
        
        .toast {
            background: #25d366;
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .toast.error {
            background: linear-gradient(135deg, #ff3b30, #ff5e55);
        }
        
        .toast.warning {
            background: linear-gradient(135deg, #ff9500, #ffaa33);
        }
        
        .toast.info {
            background: linear-gradient(135deg, #007aff, #5ac8fa);
        }
        
        .toast-icon {
            font-size: 20px;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .toast-message {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .toast-close {
            background: none;
            color: white;
            font-size: 18px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .toast-close:hover {
            opacity: 1;
        }
        
        /* ===== LOADING STATES ===== */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 168, 132, 0.3);
            border-radius: 50%;
            border-top-color: #00a884;
            animation: spin 1s ease-in-out infinite;
        }
        
        .skeleton {
            background: linear-gradient(90deg, #2a3942 25%, #374750 50%, #2a3942 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }
        
        /* ===== MOBILE RESPONSIVE ===== */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 100%;
                position: fixed;
                top: 0;
                left: 0;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index: 2000;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .chat-area {
                width: 100%;
                flex: 1;
            }
            
            .mobile-menu-btn {
                display: flex;
                position: fixed;
                bottom: 20px;
                right: 20px;
                width: 56px;
                height: 56px;
                border-radius: 50%;
                background: linear-gradient(135deg, #00a884, #25d366);
                color: white;
                border: none;
                cursor: pointer;
                z-index: 1001;
                box-shadow: 0 8px 32px rgba(0, 168, 132, 0.4);
                align-items: center;
                justify-content: center;
                font-size: 20px;
                transition: all 0.3s ease;
            }
            
            .mobile-menu-btn:hover {
                transform: scale(1.1);
                box-shadow: 0 12px 40px rgba(0, 168, 132, 0.5);
            }
            
            .message {
                max-width: 85%;
            }
            
            .call-controls {
                padding: 20px;
                gap: 15px;
            }
            
            .call-control-btn {
                width: 55px;
                height: 55px;
                font-size: 20px;
            }
            
            .call-control-btn.end-call {
                width: 65px;
                height: 65px;
            }
            
            .local-video-container {
                width: 120px;
                height: 90px;
                bottom: 15px;
                right: 15px;
            }
            
            .login-card {
                padding: 30px 20px;
                margin: 20px;
            }
            
            .quick-users {
                grid-template-columns: 1fr;
            }
            
            /* Safe area for mobile */
            .input-area, .chat-header-area, .sidebar-header {
                padding-bottom: max(16px, env(safe-area-inset-bottom));
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
            }
        }
        
        @media (max-width: 480px) {
            .message {
                max-width: 90%;
            }
            
            .message-image {
                max-width: 240px;
            }
            
            .modal-content {
                padding: 24px 20px;
                width: 95%;
            }
            
            .modal-footer {
                flex-direction: column;
            }
            
            .chat-header-area,
            .sidebar-header {
                padding: 12px;
            }
            
            .input-area {
                padding: 12px;
            }
        }
        
        /* ===== CUSTOM SCROLLBARS ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #2a3942;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #374750;
        }
        
        /* ===== UPLOAD PROGRESS ===== */
        .upload-progress {
            background: #2a3942;
            padding: 12px;
            border-radius: 12px;
            margin: 8px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 300px;
            align-self: flex-end;
            animation: fadeIn 0.3s ease;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .progress-filename {
            color: #e4e6eb;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            margin-right: 10px;
        }
        
        .progress-percentage {
            color: #00a884;
            font-weight: bold;
        }
        
        .progress-track {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00a884, #25d366);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* ===== INCOMING CALL ===== */
        .incoming-call {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 21, 32, 0.95);
            z-index: 15000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }
        
        .incoming-call-content {
            text-align: center;
            background: #202c33;
            padding: 40px;
            border-radius: 20px;
            border: 1px solid #2a3942;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .incoming-call-avatar {
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
        }
        
        .incoming-call-name {
            font-size: 24px;
            font-weight: 600;
            color: #e4e6eb;
            margin-bottom: 8px;
        }
        
        .incoming-call-type {
            color: #8696a0;
            margin-bottom: 20px;
        }
        
        .incoming-call-timer {
            color: #00a884;
            font-size: 14px;
            margin-bottom: 30px;
        }
        
        .incoming-call-actions {
            display: flex;
            gap: 12px;
        }
        
        /* ===== EMOJI PICKER ===== */
        .emoji-picker {
            position: absolute;
            bottom: 80px;
            left: 20px;
            background: #202c33;
            border-radius: 16px;
            padding: 16px;
            border: 1px solid #2a3942;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            width: 320px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        
        .emoji-category {
            margin-bottom: 16px;
        }
        
        .emoji-category-title {
            color: #8696a0;
            font-size: 12px;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid #2a3942;
        }
        
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
        }
        
        .emoji {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
        }
        
        .emoji:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* ===== DELETED MESSAGE STYLE ===== */
        .message-deleted {
            opacity: 0.7;
            font-style: italic;
            color: #8696a0 !important;
            background: #2a3942 !important;
        }
        
        /* ===== VOICE MESSAGE RECORDING ===== */
        .voice-recording {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 40px;
            border-radius: 20px;
            z-index: 10000;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid #ff3b30;
        }
        
        .recording-visualizer {
            display: flex;
            gap: 4px;
            align-items: flex-end;
            justify-content: center;
            height: 100px;
            margin: 20px 0;
        }
        
        .visualizer-bar {
            width: 8px;
            background: #ff3b30;
            border-radius: 4px;
            animation: bounce 0.5s infinite alternate;
        }
        
        .recording-timer {
            font-size: 24px;
            font-weight: bold;
            color: white;
            margin: 20px 0;
        }
        
        .recording-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        /* ===== GROUP SETTINGS ===== */
        .group-member-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #2a3942;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .admin-badge {
            background: #00a884;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        
        /* ===== TOUCH OPTIMIZATIONS ===== */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* ===== SWIPE GESTURE HINT ===== */
        .swipe-hint {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #8696a0;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* ===== MESSAGE CONTEXT MENU ===== */
        .message-context-menu {
            position: absolute;
            background: #202c33;
            border-radius: 8px;
            padding: 8px 0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid #2a3942;
            z-index: 1000;
            min-width: 160px;
            display: none;
        }
        
        .context-menu-item {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .context-menu-item:hover {
            background: #2a3942;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>
        
        <!-- Login Screen -->
        <div id="loginScreen" class="screen">
            <div class="login-card">
                <div class="logo-container">
                    <div class="logo">WebChat Pro</div>
                    <div class="tagline">Enterprise Secure Messaging</div>
                </div>
                
                <form id="loginForm">
                    <div class="input-group">
                        <i class="fas fa-envelope input-icon"></i>
                        <input type="email" id="email" class="form-input" placeholder="E-Mail Adresse" required>
                    </div>
                    
                    <div class="input-group">
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" id="password" class="form-input" placeholder="Passwort" required>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <label class="checkbox-label">
                            <input type="checkbox" id="rememberMe">
                            Angemeldet bleiben
                        </label>
                        <a href="#" id="forgotPassword" class="text-sm">Passwort vergessen?</a>
                    </div>
                    
                    <button type="submit" class="btn btn-primary mb-4">
                        <i class="fas fa-sign-in-alt"></i>
                        Anmelden / Registrieren
                    </button>
                    
                    <div class="quick-users">
                        <button type="button" id="quickLogin1" class="quick-user-btn">
                            <div class="user-avatar-small">U1</div>
                            <span>User 1</span>
                        </button>
                        <button type="button" id="quickLogin2" class="quick-user-btn">
                            <div class="user-avatar-small">U2</div>
                            <span>User 2</span>
                        </button>
                        <button type="button" id="quickLogin3" class="quick-user-btn">
                            <div class="user-avatar-small">U3</div>
                            <span>User 3</span>
                        </button>
                    </div>
                    
                    <div id="loginError" class="error-message"></div>
                    
                    <div class="text-center mt-4 pt-4 border-t border-gray-700">
                        <div class="text-sm text-gray-500 mb-2">Sichere, Ende-zu-Ende verschlsselte Kommunikation</div>
                        <div class="flex justify-center gap-4">
                            <i class="fas fa-shield-alt text-green-500"></i>
                            <i class="fas fa-lock text-green-500"></i>
                            <i class="fas fa-video text-green-500"></i>
                            <i class="fas fa-phone text-green-500"></i>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Main App Screen -->
        <div id="mainScreen" class="container">
            <!-- Mobile Menu Button -->
            <button id="mobileMenuBtn" class="mobile-menu-btn hidden">
                <i class="fas fa-bars"></i>
            </button>
            
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="flex justify-between items-center">
                        <div class="user-profile" onclick="showProfileModal()">
                            <div class="avatar" id="userAvatar"></div>
                            <div class="user-info">
                                <div class="user-name" id="userName">Benutzer</div>
                                <div class="user-status">
                                    <div class="status-dot"></div>
                                    <span id="userStatus">Online</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="header-actions">
                            <button class="icon-btn" onclick="startVideoCall()" title="Videoanruf">
                                <i class="fas fa-video"></i>
                            </button>
                            <button class="icon-btn" onclick="startVoiceCall()" title="Sprachanruf">
                                <i class="fas fa-phone"></i>
                            </button>
                            <button class="icon-btn" onclick="logout()" title="Abmelden">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" data-tab="chats">
                        <i class="fas fa-comments"></i>
                        <span>Chats</span>
                    </button>
                    <button class="tab" data-tab="contacts">
                        <i class="fas fa-users"></i>
                        <span>Kontakte</span>
                    </button>
                    <button class="tab" data-tab="groups">
                        <i class="fas fa-user-group"></i>
                        <span>Gruppen</span>
                    </button>
                    <button class="tab" data-tab="calls">
                        <i class="fas fa-phone"></i>
                        <span>Anrufe</span>
                    </button>
                </div>
                
                <!-- Search -->
                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search text-gray-500"></i>
                        <input type="text" id="searchInput" class="search-input" placeholder="Suchen...">
                    </div>
                </div>
                
                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Chats Tab -->
                    <div id="chatsTab" class="tab-pane active">
                        <div id="chatList" class="chat-list"></div>
                        <div id="chatsEmpty" class="empty-state hidden">
                            <i class="fas fa-comments empty-icon"></i>
                            <h3>Keine Chats</h3>
                            <p>Starte eine neue Konversation</p>
                        </div>
                    </div>
                    
                    <!-- Contacts Tab -->
                    <div id="contactsTab" class="tab-pane hidden">
                        <div class="p-4">
                            <button onclick="showAddContactModal()" class="btn btn-primary w-full mb-4">
                                <i class="fas fa-user-plus"></i> Kontakt hinzufgen
                            </button>
                            <div id="contactsList"></div>
                            <div id="contactsEmpty" class="empty-state hidden">
                                <i class="fas fa-users empty-icon"></i>
                                <h3>Keine Kontakte</h3>
                                <p>Fge Kontakte hinzu um zu chatten</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Groups Tab -->
                    <div id="groupsTab" class="tab-pane hidden">
                        <div class="p-4">
                            <button onclick="showCreateGroupModal()" class="btn btn-primary w-full mb-4">
                                <i class="fas fa-plus-circle"></i> Neue Gruppe
                            </button>
                            <div id="groupsList"></div>
                            <div id="groupsEmpty" class="empty-state hidden">
                                <i class="fas fa-user-group empty-icon"></i>
                                <h3>Keine Gruppen</h3>
                                <p>Erstelle deine erste Gruppe</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Calls Tab -->
                    <div id="callsTab" class="tab-pane hidden">
                        <div class="p-4">
                            <div id="callsList"></div>
                            <div id="callsEmpty" class="empty-state hidden">
                                <i class="fas fa-phone empty-icon"></i>
                                <h3>Keine Anrufe</h3>
                                <p>Hier erscheint deine Anrufhistorie</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Chat Area -->
            <div class="chat-area">
                <!-- Chat Header -->
                <div class="chat-header-area">
                    <div class="contact-info">
                        <div class="contact-avatar" id="contactAvatar">?</div>
                        <div class="contact-details">
                            <div class="contact-name" id="contactName">Whle einen Chat</div>
                            <div class="contact-status" id="contactStatus">Verfgbar</div>
                            <div id="typingIndicator" class="typing-indicator hidden">
                                <span id="typingUser"></span> schreibt...
                                <div class="typing-dots">
                                    <div class="typing-dot"></div>
                                    <div class="typing-dot"></div>
                                    <div class="typing-dot"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-actions">
                        <button class="icon-btn" onclick="startCallWithContact('voice')" title="Anrufen">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="icon-btn" onclick="startCallWithContact('video')" title="Videoanruf">
                            <i class="fas fa-video"></i>
                        </button>
                        <button class="icon-btn" onclick="showChatSettings()" title="Einstellungen">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Messages Container -->
                <div class="messages-container">
                    <div class="messages-scroll" id="messagesScroll">
                        <div class="message message-system">
                            Willkommen bei WebChat Pro! Whle einen Chat aus der Sidebar oder starte eine neue Konversation.
                        </div>
                    </div>
                </div>
                
                <!-- Message Input -->
                <div class="input-area">
                    <div class="input-tools">
                        <button class="tool-btn" onclick="toggleEmojiPicker()" title="Emoji">
                            <i class="far fa-smile"></i>
                        </button>
                        <button class="tool-btn" onclick="document.getElementById('fileInput').click()" title="Bild/Datei">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="tool-btn" id="voiceMessageBtn" onclick="startVoiceMessage()" title="Sprachnachricht">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="tool-btn" onclick="showPollModal()" title="Umfrage">
                            <i class="fas fa-poll"></i>
                        </button>
                    </div>
                    
                    <div class="message-input-container">
                        <textarea id="messageInput" class="message-input" placeholder="Nachricht eingeben..." 
                                  rows="1" oninput="handleTyping()"></textarea>
                    </div>
                    
                    <button id="sendButton" class="send-btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                
                <!-- Emoji Picker -->
                <div id="emojiPicker" class="emoji-picker"></div>
                
                <!-- Hidden File Input -->
                <input type="file" id="fileInput" multiple accept="image/*,.pdf,.doc,.docx,.txt,.mp3,.mp4,.webm" style="display: none;">
            </div>
        </div>
        
        <!-- Call Interface -->
        <div id="callContainer" class="call-container">
            <div class="call-header">
                <button class="icon-btn" onclick="toggleParticipants()" title="Teilnehmer">
                    <i class="fas fa-users"></i>
                </button>
                
                <div class="call-info">
                    <div class="call-title" id="callTitle"></div>
                    <div class="call-status" id="callStatus">Verbinden...</div>
                    <div class="call-duration" id="callDuration">00:00</div>
                </div>
                
                <button class="icon-btn" onclick="toggleFullscreen()" title="Vollbild">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
            
            <div class="video-container">
                <div class="remote-video-container">
                    <video id="remoteVideo" class="remote-video" autoplay playsinline></video>
                    <div id="participantsPanel" class="hidden absolute top-4 left-4 bg-black/50 backdrop-blur p-3 rounded-lg">
                        <h4 class="mb-2 font-semibold">Teilnehmer</h4>
                        <div id="participantsList"></div>
                    </div>
                </div>
                
                <div class="local-video-container">
                    <video id="localVideo" class="local-video" autoplay playsinline muted></video>
                </div>
            </div>
            
            <div class="call-controls">
                <button class="call-control-btn" onclick="toggleMute()" id="muteBtn" title="Stummschalten">
                    <i class="fas fa-microphone"></i>
                </button>
                
                <button class="call-control-btn" onclick="toggleVideo()" id="videoBtn" title="Video">
                    <i class="fas fa-video"></i>
                </button>
                
                <button class="call-control-btn" onclick="toggleScreenShare()" id="screenShareBtn" title="Bildschirm teilen">
                    <i class="fas fa-desktop"></i>
                </button>
                
                <button class="call-control-btn end-call" onclick="endCall()" title="Beenden">
                    <i class="fas fa-phone-slash"></i>
                </button>
                
                <button class="call-control-btn" onclick="toggleAudioOutput()" id="audioOutputBtn" title="Lautsprecher">
                    <i class="fas fa-volume-up"></i>
                </button>
                
                <button class="call-control-btn" onclick="toggleRecording()" id="recordBtn" title="Aufnahme">
                    <i class="fas fa-circle"></i>
                </button>
            </div>
        </div>
        
        <!-- Incoming Call -->
        <div id="incomingCall" class="incoming-call">
            <div class="incoming-call-content">
                <div class="avatar incoming-call-avatar" id="incomingCallAvatar"></div>
                <div class="incoming-call-name" id="incomingCallName"></div>
                <div class="incoming-call-type" id="incomingCallType"></div>
                <div class="incoming-call-timer" id="incomingCallTimer"></div>
                
                <div class="incoming-call-actions">
                    <button class="btn btn-danger flex-1" onclick="rejectCall()">
                        <i class="fas fa-phone-slash"></i> Ablehnen
                    </button>
                    <button class="btn btn-primary flex-1" onclick="acceptCall()">
                        <i class="fas fa-phone"></i> Annehmen
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Voice Recording Overlay -->
        <div id="voiceRecordingOverlay" class="voice-recording hidden">
            <div class="recording-timer" id="recordingTimer">00:00</div>
            <div class="recording-visualizer" id="recordingVisualizer"></div>
            <div class="recording-controls">
                <button class="btn btn-danger" onclick="stopVoiceRecording()">
                    <i class="fas fa-stop"></i> Stoppen
                </button>
                <button class="btn btn-secondary" onclick="cancelVoiceRecording()">
                    <i class="fas fa-times"></i> Abbrechen
                </button>
            </div>
            <div class="text-sm text-gray-400 mt-4">Sprachnachricht aufnehmen...</div>
        </div>
        
        <!-- Modals -->
        <div id="profileModal" class="modal">
            <div class="modal-content">
                <div class="modal-close" onclick="closeModal('profileModal')">
                    <i class="fas fa-times"></i>
                </div>
                
                <div class="modal-header">
                    <div class="modal-title">Profil bearbeiten</div>
                    <div class="modal-subtitle">Passe dein Profil an</div>
                </div>
                
                <div class="modal-body">
                    <div class="text-center mb-6">
                        <div class="avatar mx-auto mb-3" id="profileAvatar" style="width: 100px; height: 100px; cursor: pointer;" 
                             onclick="document.getElementById('avatarUpload').click()">
                            <i class="fas fa-camera text-xl opacity-70"></i>
                        </div>
                        <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
                        <div class="text-sm text-gray-500">Klicken zum ndern</div>
                    </div>
                    
                    <div class="input-group mb-4">
                        <i class="fas fa-user input-icon"></i>
                        <input type="text" id="profileName" class="form-input" placeholder="Benutzername">
                    </div>
                    
                    <div class="input-group">
                        <i class="fas fa-comment input-icon"></i>
                        <input type="text" id="profileStatusText" class="form-input" placeholder="Status">
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-secondary flex-1" onclick="closeModal('profileModal')">Abbrechen</button>
                    <button class="btn btn-primary flex-1" onclick="updateProfile()">Speichern</button>
                </div>
            </div>
        </div>
        
        <div id="addContactModal" class="modal">
            <div class="modal-content">
                <div class="modal-close" onclick="closeModal('addContactModal')">
                    <i class="fas fa-times"></i>
                </div>
                
                <div class="modal-header">
                    <div class="modal-title">Kontakt hinzufgen</div>
                    <div class="modal-subtitle">Gib die E-Mail des Kontakts ein</div>
                </div>
                
                <div class="modal-body">
                    <div class="input-group">
                        <i class="fas fa-envelope input-icon"></i>
                        <input type="email" id="contactEmail" class="form-input" placeholder="email@beispiel.de">
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-secondary flex-1" onclick="closeModal('addContactModal')">Abbrechen</button>
                    <button class="btn btn-primary flex-1" onclick="addContact()">Hinzufgen</button>
                </div>
            </div>
        </div>
        
        <div id="createGroupModal" class="modal">
            <div class="modal-content">
                <div class="modal-close" onclick="closeModal('createGroupModal')">
                    <i class="fas fa-times"></i>
                </div>
                
                <div class="modal-header">
                    <div class="modal-title">Neue Gruppe</div>
                    <div class="modal-subtitle">Erstelle eine Gruppe fr mehrere Teilnehmer</div>
                </div>
                
                <div class="modal-body">
                    <div class="input-group mb-4">
                        <i class="fas fa-users input-icon"></i>
                        <input type="text" id="groupName" class="form-input" placeholder="Gruppenname">
                    </div>
                    
                    <div class="mb-2 text-sm text-gray-500">Mitglieder auswhlen:</div>
                    <div id="groupMembersList" class="max-h-60 overflow-y-auto p-3 bg-gray-900 rounded-lg"></div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-secondary flex-1" onclick="closeModal('createGroupModal')">Abbrechen</button>
                    <button class="btn btn-primary flex-1" onclick="createGroup()">Erstellen</button>
                </div>
            </div>
        </div>
        
        <div id="groupSettingsModal" class="modal">
            <div class="modal-content">
                <div class="modal-close" onclick="closeModal('groupSettingsModal')">
                    <i class="fas fa-times"></i>
                </div>
                
                <div class="modal-header">
                    <div class="modal-title">Gruppeneinstellungen</div>
                    <div class="modal-subtitle" id="groupSettingsSubtitle"></div>
                </div>
                
                <div class="modal-body">
                    <div class="input-group mb-4">
                        <i class="fas fa-users input-icon"></i>
                        <input type="text" id="editGroupName" class="form-input" placeholder="Gruppenname">
                    </div>
                    
                    <div class="input-group mb-4">
                        <i class="fas fa-pen input-icon"></i>
                        <textarea id="editGroupDescription" class="form-input" placeholder="Gruppenbeschreibung"></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold">Mitglieder</h4>
                            <button class="btn btn-sm btn-primary" onclick="showAddMemberModal()">
                                <i class="fas fa-user-plus"></i> Hinzufgen
                            </button>
                        </div>
                        <div id="groupMembersSettings" class="space-y-2 max-h-60 overflow-y-auto"></div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-danger flex-1" onclick="leaveGroup()">Gruppe verlassen</button>
                    <button class="btn btn-secondary flex-1" onclick="closeModal('groupSettingsModal')">Abbrechen</button>
                    <button class="btn btn-primary flex-1" onclick="saveGroupSettings()">Speichern</button>
                </div>
            </div>
        </div>
        
        <div id="addMemberModal" class="modal">
            <div class="modal-content">
                <div class="modal-close" onclick="closeModal('addMemberModal')">
                    <i class="fas fa-times"></i>
                </div>
                
                <div class="modal-header">
                    <div class="modal-title">Mitglied hinzufgen</div>
                    <div class="modal-subtitle">Fge Kontakte zur Gruppe hinzu</div>
                </div>
                
                <div class="modal-body">
                    <div id="availableContactsList" class="max-h-60 overflow-y-auto space-y-2"></div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-secondary flex-1" onclick="closeModal('addMemberModal')">Abbrechen</button>
                    <button class="btn btn-primary flex-1" onclick="addMembersToGroup()">Hinzufgen</button>
                </div>
            </div>
        </div>
        
        <div id="pollModal" class="modal">
            <div class="modal-content">
                <div class="modal-close" onclick="closeModal('pollModal')">
                    <i class="fas fa-times"></i>
                </div>
                
                <div class="modal-header">
                    <div class="modal-title">Umfrage erstellen</div>
                    <div class="modal-subtitle">Stelle eine Frage an den Chat</div>
                </div>
                
                <div class="modal-body">
                    <div class="input-group mb-4">
                        <i class="fas fa-question input-icon"></i>
                        <input type="text" id="pollQuestion" class="form-input" placeholder="Frage eingeben...">
                    </div>
                    
                    <div class="mb-2 text-sm text-gray-500">Optionen:</div>
                    <div id="pollOptions">
                        <div class="input-group mb-2">
                            <input type="text" class="form-input poll-option" placeholder="Option 1">
                        </div>
                        <div class="input-group mb-2">
                            <input type="text" class="form-input poll-option" placeholder="Option 2">
                        </div>
                    </div>
                    
                    <button class="btn btn-ghost w-full mb-4" onclick="addPollOption()">
                        <i class="fas fa-plus"></i> Option hinzufgen
                    </button>
                    
                    <div class="flex items-center gap-4">
                        <label class="checkbox-label">
                            <input type="checkbox" id="pollAnonymous">
                            Anonym
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="pollMultiple">
                            Mehrfachauswahl
                        </label>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-secondary flex-1" onclick="closeModal('pollModal')">Abbrechen</button>
                    <button class="btn btn-primary flex-1" onclick="createPoll()">Erstellen</button>
                </div>
            </div>
        </div>
        
        <div id="imagePreviewModal" class="modal">
            <div class="modal-content" style="max-width: 90vw; max-height: 90vh; background: transparent; border: none; padding: 0;">
                <div class="modal-close" onclick="closeModal('imagePreviewModal')">
                    <i class="fas fa-times"></i>
                </div>
                <img id="previewImage" src="" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">
            </div>
        </div>
    </div>

    <!-- ===== MAIN APPLICATION SCRIPT ===== -->
// ===== MAIN APPLICATION SCRIPT =====
<script>
// Supabase Initialisierung
(function() {
    window.SUPABASE_URL = 'https://sxtujrbabtecydzjhexy.supabase.co';
    window.SUPABASE_ANON_KEY = 'sb_publishable_E4nGvf0STP6fyLLRaXDOcw_vOyIe3B7';
    
    console.log('Initialisiere Supabase mit:', window.SUPABASE_URL);
    
    try {
        window.supabaseClient = supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY, {
            auth: {
                autoRefreshToken: true,
                persistSession: true,
                detectSessionInUrl: true
            }
        });
        
        console.log(' Supabase Client erfolgreich initialisiert');
        
    } catch (error) {
        console.error(' Fehler bei Supabase-Initialisierung:', error);
        
        // Fallback: Mock-Client
        window.supabaseClient = {
            auth: {
                signInWithPassword: async () => ({ 
                    data: { user: { id: 'demo-' + Date.now(), email: 'test@test.de' } }, 
                    error: null 
                }),
                signUp: async () => ({ data: { user: { id: 'demo-' + Date.now(), email: 'test@test.de' } }, error: null }),
                signOut: async () => ({ error: null }),
                getSession: async () => ({ data: { session: null }, error: null }),
                onAuthStateChange: (callback) => {
                    setTimeout(() => callback('SIGNED_IN', { user: { id: 'demo-user' } }), 100);
                    return { data: { subscription: { unsubscribe: () => {} } } };
                }
            },
            from: () => ({
                select: () => ({
                    eq: () => ({
                        maybeSingle: async () => ({ 
                            data: { 
                                id: 'demo-user', 
                                email: 'test@test.de',
                                display_name: 'Test User',
                                status: 'online',
                                contacts: ['user2', 'user3'],
                                avatar_url: ''
                            }, 
                            error: null 
                        }),
                        single: async () => ({ 
                            data: { 
                                id: 'demo-user', 
                                email: 'test@test.de',
                                display_name: 'Test User',
                                status: 'online',
                                contacts: ['user2', 'user3'],
                                avatar_url: ''
                            }, 
                            error: null 
                        })
                    }),
                    neq: () => ({
                        order: async () => ({ 
                            data: [
                                { id: 'user2', email: 'user2@test.de', display_name: 'Max Mustermann', status: 'online', avatar_url: '' },
                                { id: 'user3', email: 'user3@test.de', display_name: 'Anna Schmidt', status: 'offline', avatar_url: '' }
                            ], 
                            error: null 
                        })
                    }),
                    contains: () => ({
                        order: async () => ({ 
                            data: [], 
                            error: null 
                        })
                    }),
                    or: () => ({
                        maybeSingle: async () => ({ data: null, error: null })
                    })
                }),
                insert: async (data) => { 
                    console.log('Mock INSERT:', data);
                    return { data: [{ id: 'mock-' + Date.now(), ...data }], error: null }; 
                },
                update: async () => ({ data: null, error: null })
            }),
            channel: () => ({
                on: () => ({ subscribe: () => ({ unsubscribe: () => {} }) })
            })
        };
        console.warn(' Verwende Mock Supabase Client');
    }
})();

// Global State
let currentUser = null;
let currentChat = null;
let contacts = [];
let users = [];
let chats = [];
let groups = [];
let calls = [];

// Real-time Subscriptions
let messageSubscription = null;
let typingSubscription = null;
let presenceSubscription = null;
let callSubscription = null;

// Typing State
let typingTimeout = null;
let isTyping = false;

// Media
let mediaRecorder = null;
let audioChunks = [];
let recordingTimer = null;
let recordingStartTime = null;

// WebRTC
let peerConnection = null;
let localStream = null;
let remoteStream = null;
let dataChannel = null;
let currentCall = null;
let callStartTime = null;
let callTimer = null;
let screenStream = null;

// Message Context Menu
let currentContextMessage = null;

// ICE Servers for WebRTC
const iceServers = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        { urls: 'stun:stun3.l.google.com:19302' },
        { urls: 'stun:stun4.l.google.com:19302' }
    ]
};

// ===== UTILITY FUNCTIONS =====
function showToast(message, type = 'success', duration = 3000) {
    const toastContainer = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.id = toastId;
    
    const icons = {
        success: 'fas fa-check-circle',
        error: 'fas fa-exclamation-circle',
        warning: 'fas fa-exclamation-triangle',
        info: 'fas fa-info-circle'
    };
    
    toast.innerHTML = `
        <i class="${icons[type] || icons.info} toast-icon"></i>
        <div class="toast-content">
            <div class="toast-message">${escapeHtml(message)}</div>
        </div>
        <button class="toast-close" onclick="document.getElementById('${toastId}').remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
        const toastElement = document.getElementById(toastId);
        if (toastElement) {
            toastElement.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toastElement.remove(), 300);
        }
    }, duration);
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(date) {
    if (!date) return '';
    const now = new Date();
    const msgDate = new Date(date);
    const diff = now - msgDate;
    
    if (diff < 60000) return 'Gerade eben';
    if (diff < 3600000) return `${Math.floor(diff / 60000)} min`;
    if (diff < 86400000) return `${Math.floor(diff / 3600000)} h`;
    if (diff < 604800000) return `${Math.floor(diff / 86400000)} d`;
    
    return msgDate.toLocaleDateString('de-DE');
}

function formatTime(date) {
    if (!date) return '';
    return new Date(date).toLocaleTimeString('de-DE', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
}

function formatFileSize(bytes) {
    if (!bytes) return '0 Bytes';
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function showModal(modalId) {
    document.getElementById(modalId).style.display = 'flex';
}

function getUserInitial(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) return '?';
    const displayName = user.display_name || user.email.split('@')[0];
    return displayName.charAt(0).toUpperCase();
}

function getUserName(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) return 'Unbekannt';
    return user.display_name || user.email.split('@')[0];
}

function getUserAvatar(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) return null;
    return user.avatar_url;
}

// ===== AUTHENTICATION =====
async function handleLogin(e) {
    if (e) e.preventDefault();
    
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    if (!email || !password) {
        showToast('Bitte Email und Passwort eingeben', 'error');
        return;
    }
    
    try {
        // Try to sign in
        const { data: signInData, error: signInError } = await window.supabaseClient.auth.signInWithPassword({
            email,
            password
        });
        
        if (signInError) {
            // If sign in fails, try to sign up
            const { data: signUpData, error: signUpError } = await window.supabaseClient.auth.signUp({
                email,
                password,
                options: {
                    data: {
                        display_name: email.split('@')[0]
                    }
                }
            });
            
            if (signUpError) {
                throw new Error(signUpError.message);
            }
            
            showToast('Account erstellt! Du kannst dich jetzt anmelden.', 'success');
            document.getElementById('password').value = '';
            return;
        }
        
        currentUser = signInData.user;
        await initializeUser();
        
    } catch (error) {
        console.error('Login error:', error);
        showToast('Fehler: ' + error.message, 'error');
    }
}

async function quickLogin(userNum) {
    const testUsers = [
        { email: 'test1@test.de', password: 'test123', name: 'User 1' },
        { email: 'test2@test.de', password: 'test123', name: 'User 2' },
        { email: 'test3@test.de', password: 'test123', name: 'User 3' }
    ];
    
    const user = testUsers[userNum - 1];
    document.getElementById('email').value = user.email;
    document.getElementById('password').value = user.password;
    
    // Simulate form submission
    const event = new Event('submit');
    await handleLogin(event);
}

async function initializeUser() {
    try {
        // Check if profile exists, create if not
        const { data: profile, error: fetchError } = await window.supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', currentUser.id)
            .maybeSingle();
        
        if (fetchError || !profile) {
            // Create new profile
            const { error: insertError } = await window.supabaseClient
                .from('profiles')
                .insert({
                    id: currentUser.id,
                    email: currentUser.email,
                    display_name: currentUser.user_metadata?.display_name || currentUser.email.split('@')[0],
                    status: 'online',
                    status_text: 'Verfgbar',
                    avatar_url: '',
                    contacts: [],
                    last_seen: new Date().toISOString(),
                    created_at: new Date().toISOString()
                })
                .select()
                .single();
            
            if (insertError) {
                console.log('Profile creation:', insertError.message);
            }
        } else {
            // Update online status
            await window.supabaseClient
                .from('profiles')
                .update({ 
                    status: 'online',
                    last_seen: new Date().toISOString()
                })
                .eq('id', currentUser.id);
        }
        
        // Switch to main screen
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainScreen').style.display = 'flex';
        
        // Show mobile menu button if needed
        if (window.innerWidth <= 768) {
            document.getElementById('mobileMenuBtn').classList.remove('hidden');
        }
        
        // Load user data
        await loadUserData();
        
        // Setup real-time listeners
        setupRealtimeListeners();
        
        showToast('Erfolgreich eingeloggt!', 'success');
        
    } catch (error) {
        console.error('Error initializing user:', error);
        showToast('Fehler beim Initialisieren: ' + error.message, 'error');
    }
}

async function loadUserData() {
    try {
        // Load profile
        const { data: profile } = await window.supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', currentUser.id)
            .single();
        
        if (profile) {
            updateProfileUI(profile);
        }
        
        // Load all users
        await loadAllUsers();
        
        // Load contacts
        await loadContacts();
        
        // Load chats
        await loadChats();
        
        // Load calls history
        await loadCallsHistory();
        
        // Initialize emoji picker
        initEmojiPicker();
        
    } catch (error) {
        console.error('Error loading user data:', error);
        showToast('Fehler beim Laden der Benutzerdaten', 'error');
    }
}

function updateProfileUI(profile) {
    const avatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const userStatus = document.getElementById('userStatus');
    
    const displayName = profile.display_name || currentUser.email.split('@')[0];
    userName.textContent = displayName;
    userStatus.textContent = profile.status_text || 'Online';
    
    // Set avatar with background image if exists
    if (profile.avatar_url) {
        avatar.style.backgroundImage = `url(${profile.avatar_url})`;
        avatar.style.backgroundSize = 'cover';
        avatar.style.backgroundPosition = 'center';
        avatar.innerHTML = '';
    } else {
        avatar.style.backgroundImage = 'none';
        avatar.textContent = displayName.charAt(0).toUpperCase();
    }
    
    // Update profile modal
    document.getElementById('profileName').value = displayName;
    document.getElementById('profileStatusText').value = profile.status_text || '';
    
    const profileAvatar = document.getElementById('profileAvatar');
    if (profile.avatar_url) {
        profileAvatar.style.backgroundImage = `url(${profile.avatar_url})`;
        profileAvatar.style.backgroundSize = 'cover';
        profileAvatar.style.backgroundPosition = 'center';
        profileAvatar.innerHTML = '<i class="fas fa-camera text-xl opacity-70"></i>';
    } else {
        profileAvatar.style.backgroundImage = 'none';
        profileAvatar.innerHTML = displayName.charAt(0).toUpperCase();
    }
}

async function logout() {
    if (confirm('Wirklich abmelden?')) {
        try {
            // Update status
            await window.supabaseClient
                .from('profiles')
                .update({ 
                    status: 'offline',
                    last_seen: new Date().toISOString()
                })
                .eq('id', currentUser.id);
            
            // Sign out
            await window.supabaseClient.auth.signOut();
            
            // Reset state
            currentUser = null;
            currentChat = null;
            contacts = [];
            chats = [];
            users = [];
            
            // Unsubscribe from all
            if (messageSubscription) messageSubscription.unsubscribe();
            if (typingSubscription) typingSubscription.unsubscribe();
            if (presenceSubscription) presenceSubscription.unsubscribe();
            if (callSubscription) callSubscription.unsubscribe();
            
            // Reset UI
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mobileMenuBtn').classList.add('hidden');
            
            // Clear forms
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            
            showToast('Erfolgreich abgemeldet', 'success');
            
        } catch (error) {
            console.error('Error logging out:', error);
            showToast('Fehler beim Abmelden', 'error');
        }
    }
}

// ===== PROFILE PICTURE UPLOAD =====
document.getElementById('avatarUpload').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file || !currentUser) return;
    
    try {
        // Validate file
        if (!file.type.startsWith('image/')) {
            showToast('Bitte nur Bilder hochladen', 'error');
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) { // 5MB limit
            showToast('Bild zu gro (max. 5MB)', 'error');
            return;
        }
        
        showToast('Bild wird hochgeladen...', 'info');
        
        // Upload to Supabase Storage
        const fileExt = file.name.split('.').pop();
        const fileName = `${currentUser.id}-${Date.now()}.${fileExt}`;
        const filePath = `avatars/${fileName}`;
        
        const { data, error: uploadError } = await window.supabaseClient.storage
            .from('files')
            .upload(filePath, file, {
                cacheControl: '3600',
                upsert: true
            });
        
        if (uploadError) throw uploadError;
        
        // Get public URL
        const { data: { publicUrl } } = window.supabaseClient.storage
            .from('files')
            .getPublicUrl(filePath);
        
        // Update profile with avatar URL
        await window.supabaseClient
            .from('profiles')
            .update({
                avatar_url: publicUrl,
                updated_at: new Date().toISOString()
            })
            .eq('id', currentUser.id);
        
        // Update UI
        await loadUserData();
        
        showToast('Profilbild aktualisiert!', 'success');
        
    } catch (error) {
        console.error('Error uploading avatar:', error);
        showToast('Fehler beim Hochladen: ' + error.message, 'error');
    }
});

async function updateProfile() {
    const name = document.getElementById('profileName').value.trim();
    const status = document.getElementById('profileStatusText').value.trim();
    
    if (!name) {
        showToast('Name darf nicht leer sein', 'error');
        return;
    }
    
    try {
        await window.supabaseClient
            .from('profiles')
            .update({
                display_name: name,
                status_text: status,
                updated_at: new Date().toISOString()
            })
            .eq('id', currentUser.id);
        
        // Update UI
        await loadUserData();
        closeModal('profileModal');
        showToast('Profil aktualisiert', 'success');
        
    } catch (error) {
        console.error('Error updating profile:', error);
        showToast('Fehler beim Speichern: ' + error.message, 'error');
    }
}

// ===== CONTACTS =====
async function loadContacts() {
    try {
        const { data: profile } = await window.supabaseClient
            .from('profiles')
            .select('contacts')
            .eq('id', currentUser.id)
            .single();
        
        contacts = profile?.contacts || [];
        updateContactsList();
        
    } catch (error) {
        console.error('Error loading contacts:', error);
        contacts = [];
    }
}

async function loadAllUsers() {
    try {
        const { data } = await window.supabaseClient
            .from('profiles')
            .select('*')
            .neq('id', currentUser.id);
        
        users = data || [];
        
    } catch (error) {
        console.error('Error loading users:', error);
        users = [];
    }
}

function updateContactsList() {
    const container = document.getElementById('contactsList');
    const emptyState = document.getElementById('contactsEmpty');
    
    if (!container) return;
    
    container.innerHTML = '';
    
    if (contacts.length === 0) {
        if (emptyState) emptyState.classList.remove('hidden');
        return;
    }
    
    if (emptyState) emptyState.classList.add('hidden');
    
    // Kontakte aus der users-Liste filtern
    const contactProfiles = users.filter(user => contacts.includes(user.id));
    
    contactProfiles.forEach(contact => {
        const contactElement = createContactElement(contact);
        container.appendChild(contactElement);
    });
}

// ===== KONTAKT-ELEMENT ERSTELLEN =====
function createContactElement(contact) {
    const div = document.createElement('div');
    div.className = 'chat-item';
    div.onclick = () => startChatWithContact(contact.id);
    
    const displayName = contact.display_name || contact.email.split('@')[0];
    const status = contact.status === 'online' ? ' Online' : ' Offline';
    
    // Avatar mit oder ohne Bild
    let avatarHtml = '';
    if (contact.avatar_url) {
        avatarHtml = `<div class="chat-avatar" style="background-image: url(${contact.avatar_url}); background-size: cover; background-position: center;"></div>`;
    } else {
        avatarHtml = `<div class="chat-avatar">${displayName.charAt(0).toUpperCase()}</div>`;
    }
    
    div.innerHTML = `
        ${avatarHtml}
        <div class="chat-info">
            <div class="chat-header">
                <div class="chat-name">${escapeHtml(displayName)}</div>
            </div>
            <div class="chat-preview">
                <div class="chat-message">${escapeHtml(contact.status_text || status)}</div>
                <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation(); startCallWithContact('${contact.id}', 'voice')">
                    <i class="fas fa-phone"></i>
                </button>
            </div>
        </div>
    `;
    
    return div;
}

// ===== KONTAKT HINZUFGEN =====
async function addContact() {
    const email = document.getElementById('contactEmail').value.trim();
    
    if (!email) {
        showToast('Bitte Email eingeben', 'error');
        return;
    }
    
    if (email === currentUser.email) {
        showToast('Du kannst dich nicht selbst hinzufgen', 'error');
        return;
    }
    
    try {
        // Suchen nach Benutzer
        const { data: usersFound, error } = await window.supabaseClient
            .from('profiles')
            .select('*')
            .or(`email.eq.${email},display_name.ilike.%${email}%`)
            .neq('id', currentUser.id);
        
        if (error || !usersFound || usersFound.length === 0) {
            showToast(`Kein Benutzer mit "${email}" gefunden`, 'error');
            return;
        }
        
        const user = usersFound[0];
        
        if (contacts.includes(user.id)) {
            showToast('Kontakt bereits vorhanden', 'warning');
            return;
        }
        
        // Add to contacts
        contacts.push(user.id);
        
        await window.supabaseClient
            .from('profiles')
            .update({ contacts })
            .eq('id', currentUser.id);
        
        closeModal('addContactModal');
        showToast('Kontakt hinzugefgt', 'success');
        await loadContacts();
        
    } catch (error) {
        console.error('Error adding contact:', error);
        showToast('Fehler beim Hinzufgen: ' + error.message, 'error');
    }
}

// ===== CHATS =====
async function loadChats() {
    try {
        const { data } = await window.supabaseClient
            .from('chats')
            .select('*')
            .contains('participants', [currentUser.id])
            .order('updated_at', { ascending: false });
        
        chats = data || [];
        updateChatsList();
        
    } catch (error) {
        console.error('Error loading chats:', error);
        chats = [];
    }
}

function updateChatsList() {
    const container = document.getElementById('chatList');
    const emptyState = document.getElementById('chatsEmpty');
    
    container.innerHTML = '';
    
    if (chats.length === 0) {
        emptyState.classList.remove('hidden');
        return;
    }
    
    emptyState.classList.add('hidden');
    
    chats.forEach(chat => {
        const chatElement = createChatElement(chat);
        container.appendChild(chatElement);
    });
}

function createChatElement(chat) {
    const div = document.createElement('div');
    div.className = 'chat-item' + (currentChat?.id === chat.id ? ' active' : '');
    div.onclick = () => selectChat(chat);
    
    let chatName = 'Unbekannt';
    let lastMessage = chat.last_message || 'Starte die Konversation';
    let unreadCount = chat.unread_count || 0;
    
    if (chat.type === 'group') {
        chatName = chat.name || 'Gruppenchat';
    } else {
        const partnerId = chat.participants.find(id => id !== currentUser.id);
        const partner = users.find(u => u.id === partnerId);
        if (partner) {
            chatName = partner.display_name || partner.email.split('@')[0];
        }
    }
    
    div.innerHTML = `
        <div class="chat-avatar">${chatName.charAt(0).toUpperCase()}</div>
        <div class="chat-info">
            <div class="chat-header">
                <div class="chat-name">${escapeHtml(chatName)}</div>
                <div class="chat-time">${formatTime(chat.updated_at)}</div>
            </div>
            <div class="chat-preview">
                <div class="chat-message">${escapeHtml(lastMessage)}</div>
                ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
            </div>
        </div>
    `;
    
    return div;
}

async function selectChat(chat) {
    currentChat = chat;
    
    // Update UI
    updateChatHeader(chat);
    updateChatsList();
    
    // Load messages
    await loadMessages(chat.id);
    
    // Mark as read
    await markChatAsRead(chat.id);
    
    // Close sidebar on mobile
    if (window.innerWidth <= 768) {
        document.getElementById('sidebar').classList.remove('active');
    }
}

function updateChatHeader(chat) {
    let chatName = 'Unbekannt';
    let status = 'Verfgbar';
    
    if (chat.type === 'group') {
        chatName = chat.name || 'Gruppenchat';
        status = `${chat.participants?.length || 0} Mitglieder`;
    } else {
        const partnerId = chat.participants.find(id => id !== currentUser.id);
        const partner = users.find(u => u.id === partnerId);
        if (partner) {
            chatName = partner.display_name || partner.email.split('@')[0];
            status = partner.status_text || (partner.status === 'online' ? 'Online' : 'Offline');
            
            // Set avatar with background image if exists
            const contactAvatar = document.getElementById('contactAvatar');
            if (partner.avatar_url) {
                contactAvatar.style.backgroundImage = `url(${partner.avatar_url})`;
                contactAvatar.style.backgroundSize = 'cover';
                contactAvatar.style.backgroundPosition = 'center';
                contactAvatar.textContent = '';
            } else {
                contactAvatar.style.backgroundImage = 'none';
                contactAvatar.textContent = chatName.charAt(0).toUpperCase();
            }
        }
    }
    
    document.getElementById('contactName').textContent = chatName;
    document.getElementById('contactStatus').textContent = status;
}

async function markChatAsRead(chatId) {
    try {
        await window.supabaseClient
            .from('chats')
            .update({ unread_count: 0 })
            .eq('id', chatId);
        
        // Update local state
        const chat = chats.find(c => c.id === chatId);
        if (chat) {
            chat.unread_count = 0;
        }
    } catch (error) {
        console.error('Error marking chat as read:', error);
    }
}

async function loadMessages(chatId) {
    // Unsubscribe from old subscription
    if (messageSubscription) {
        messageSubscription.unsubscribe();
    }
    
    const container = document.getElementById('messagesScroll');
    container.innerHTML = '<div class="flex-center p-4"><div class="loading-spinner"></div></div>';
    
    try {
        const { data: messages } = await window.supabaseClient
            .from('messages')
            .select('*')
            .eq('chat_id', chatId)
            .order('created_at', { ascending: true });
        
        container.innerHTML = '';
        
        if (!messages || messages.length === 0) {
            container.innerHTML = `
                <div class="message message-system">
                    Noch keine Nachrichten. Starte die Konversation!
                </div>
            `;
            return;
        }
        
        let lastDate = null;
        
        messages.forEach(message => {
            // Add date separator
            const messageDate = new Date(message.created_at).toDateString();
            if (lastDate !== messageDate) {
                const dateDiv = document.createElement('div');
                dateDiv.className = 'message-date';
                dateDiv.textContent = new Date(message.created_at).toLocaleDateString('de-DE', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                container.appendChild(dateDiv);
                lastDate = messageDate;
            }
            
            displayMessage(message);
        });
        
        // Scroll to bottom
        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 100);
        
        // Subscribe to new messages
        messageSubscription = window.supabaseClient
            .channel('messages-' + chatId)
            .on(
                'postgres_changes',
                {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages',
                    filter: `chat_id=eq.${chatId}`
                },
                (payload) => {
                    displayMessage(payload.new);
                    
                    setTimeout(() => {
                        container.scrollTop = container.scrollHeight;
                    }, 100);
                }
            )
            .subscribe();
        
        // Subscribe to typing indicators
        setupTypingListener(chatId);
        
    } catch (error) {
        console.error('Error loading messages:', error);
        container.innerHTML = '<div class="message message-system" style="color: #ff3b30;">Fehler beim Laden der Nachrichten</div>';
    }
}

function displayMessage(message) {
    const container = document.getElementById('messagesScroll');
    const isOwn = message.sender_id === currentUser.id;
    const isDeleted = message.deleted === true;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isOwn ? 'message-out' : 'message-in'} ${isDeleted ? 'message-deleted' : ''}`;
    
    // Add context menu for own messages
    if (isOwn && !isDeleted) {
        messageDiv.oncontextmenu = (e) => {
            e.preventDefault();
            showMessageContextMenu(e, message.id);
            return false;
        };
    }
    
    let content = '';
    let senderName = '';
    
    // Sender name for group chats
    if (!isOwn && currentChat?.type === 'group') {
        const sender = users.find(u => u.id === message.sender_id);
        if (sender) {
            const displayName = sender.display_name || sender.email.split('@')[0];
            senderName = `<div class="message-sender">${escapeHtml(displayName)}</div>`;
        }
    }
    
    if (isDeleted) {
        content = '<em>Diese Nachricht wurde gelscht</em>';
    } else {
        switch (message.type) {
            case 'text':
                content = escapeHtml(message.content);
                break;
                
            case 'image':
                content = `
                    <img src="${message.file_url}" class="message-image" 
                         onclick="showImagePreview('${message.file_url}')">
                    ${message.content ? `<div class="mt-2">${escapeHtml(message.content)}</div>` : ''}
                `;
                break;
                
            case 'file':
                const fileName = message.file_name || 'Datei';
                const fileSize = message.file_size ? formatFileSize(message.file_size) : '';
                content = `
                    <div class="message-file" onclick="downloadFile('${message.file_url}', '${fileName}')">
                        <i class="fas fa-file file-icon"></i>
                        <div class="file-info">
                            <div class="file-name">${escapeHtml(fileName)}</div>
                            <div class="file-size">${fileSize}</div>
                        </div>
                    </div>
                    ${message.content ? `<div class="mt-2">${escapeHtml(message.content)}</div>` : ''}
                `;
                break;
                
            case 'audio':
                content = `
                    <div class="audio-message">
                        <audio controls class="audio-player">
                            <source src="${message.file_url}" type="audio/webm">
                        </audio>
                    </div>
                `;
                break;
                
            case 'poll':
                content = renderPoll(message);
                break;
                
            default:
                content = escapeHtml(message.content);
        }
    }
    
    const time = formatTime(message.created_at);
    const status = isOwn && !isDeleted ? (message.read ? '' : '') : '';
    
    messageDiv.innerHTML = `
        ${senderName}
        <div class="message-content">${content}</div>
        <div class="message-footer">
            <div class="message-time">${time}</div>
            ${status ? `<div class="message-status">${status}</div>` : ''}
        </div>
    `;
    
    container.appendChild(messageDiv);
}

// ===== NACHRICHTEN LSCHEN =====
async function deleteMessage(messageId) {
    if (!confirm('Nachricht wirklich lschen?')) return;
    
    try {
        const { error } = await window.supabaseClient
            .from('messages')
            .update({ 
                deleted: true,
                content: 'Diese Nachricht wurde gelscht',
                file_url: null
            })
            .eq('id', messageId)
            .eq('sender_id', currentUser.id); // Nur eigene Nachrichten
        
        if (!error) {
            showToast('Nachricht gelscht', 'success');
            await loadMessages(currentChat.id);
        } else {
            throw error;
        }
    } catch (error) {
        console.error('Error deleting message:', error);
        showToast('Fehler beim Lschen', 'error');
    }
}

function showMessageContextMenu(event, messageId) {
    // Remove existing context menu
    const existingMenu = document.querySelector('.message-context-menu');
    if (existingMenu) existingMenu.remove();
    
    // Create new context menu
    const menu = document.createElement('div');
    menu.className = 'message-context-menu';
    menu.style.position = 'fixed';
    menu.style.left = event.clientX + 'px';
    menu.style.top = event.clientY + 'px';
    
    menu.innerHTML = `
        <div class="context-menu-item" onclick="deleteMessage('${messageId}'); this.parentElement.remove()">
            <i class="fas fa-trash text-red-500"></i>
            <span>Lschen</span>
        </div>
        <div class="context-menu-item" onclick="this.parentElement.remove()">
            <i class="fas fa-copy"></i>
            <span>Kopieren</span>
        </div>
    `;
    
    document.body.appendChild(menu);
    currentContextMessage = messageId;
    
    // Close menu when clicking elsewhere
    setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
            if (!menu.contains(e.target)) {
                menu.remove();
                document.removeEventListener('click', closeMenu);
            }
        });
    }, 100);
}

// ===== SPRAXNACHRICHTEN =====
async function startVoiceMessage() {
    if (!navigator.mediaDevices || !window.MediaRecorder) {
        showToast('Audio-Aufnahme nicht untersttzt', 'error');
        return;
    }
    
    try {
        // Request microphone permission
        const stream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            }
        });
        
        // Setup MediaRecorder
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = async () => {
            await uploadAudioFile();
            // Stop all tracks
            stream.getTracks().forEach(track => track.stop());
        };
        
        // Start recording
        mediaRecorder.start();
        
        // Show recording UI
        document.getElementById('voiceRecordingOverlay').classList.remove('hidden');
        document.getElementById('voiceMessageBtn').classList.add('recording');
        
        // Start timer
        recordingStartTime = Date.now();
        updateRecordingTimer();
        recordingTimer = setInterval(updateRecordingTimer, 1000);
        
        // Create visualizer
        createRecordingVisualizer(stream);
        
        showToast('Aufnahme gestartet...', 'info');
        
    } catch (error) {
        console.error('Audio recording error:', error);
        showToast('Mikrofon-Zugriff verweigert', 'error');
    }
}

function updateRecordingTimer() {
    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
    const seconds = (elapsed % 60).toString().padStart(2, '0');
    
    document.getElementById('recordingTimer').textContent = `${minutes}:${seconds}`;
}

function createRecordingVisualizer(stream) {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const analyser = audioContext.createAnalyser();
    const microphone = audioContext.createMediaStreamSource(stream);
    const visualizer = document.getElementById('recordingVisualizer');
    
    microphone.connect(analyser);
    analyser.fftSize = 256;
    
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    
    function draw() {
        if (!mediaRecorder || mediaRecorder.state !== 'recording') return;
        
        requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArray);
        
        // Update visualizer bars
        visualizer.innerHTML = '';
        const barCount = 20;
        for (let i = 0; i < barCount; i++) {
            const value = dataArray[Math.floor(i * bufferLength / barCount)];
            const height = Math.max(4, (value / 256) * 100);
            
            const bar = document.createElement('div');
            bar.className = 'visualizer-bar';
            bar.style.height = height + 'px';
            visualizer.appendChild(bar);
        }
    }
    
    draw();
}

function stopVoiceRecording() {
    if (!mediaRecorder || mediaRecorder.state !== 'recording') return;
    
    mediaRecorder.stop();
    cleanupRecording();
    showToast('Aufnahme beendet', 'success');
}

function cancelVoiceRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
    }
    cleanupRecording();
    showToast('Aufnahme abgebrochen', 'info');
}

function cleanupRecording() {
    clearInterval(recordingTimer);
    document.getElementById('voiceRecordingOverlay').classList.add('hidden');
    document.getElementById('voiceMessageBtn').classList.remove('recording');
    
    // Clear visualizer
    document.getElementById('recordingVisualizer').innerHTML = '';
    
    // Clear chunks
    audioChunks = [];
}

async function uploadAudioFile() {
    if (audioChunks.length === 0) return;
    
    try {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const fileName = `voice-${Date.now()}.webm`;
        
        // Show progress
        showToast('Sprachnachricht wird hochgeladen...', 'info');
        
        // Upload to Supabase Storage
        const filePath = `chat-${currentChat.id}/${fileName}`;
        
        const { data, error: uploadError } = await window.supabaseClient.storage
            .from('files')
            .upload(filePath, audioBlob, {
                cacheControl: '3600',
                upsert: false
            });
        
        if (uploadError) throw uploadError;
        
        // Get public URL
        const { data: { publicUrl } } = window.supabaseClient.storage
            .from('files')
            .getPublicUrl(filePath);
        
        // Save message
        const messageData = {
            chat_id: currentChat.id,
            sender_id: currentUser.id,
            type: 'audio',
            content: ' Sprachnachricht',
            file_url: publicUrl,
            file_name: fileName,
            file_size: audioBlob.size,
            created_at: new Date().toISOString()
        };
        
        await window.supabaseClient
            .from('messages')
            .insert(messageData);
        
        // Update chat
        await window.supabaseClient
            .from('chats')
            .update({
                last_message: ' Sprachnachricht',
                updated_at: new Date().toISOString()
            })
            .eq('id', currentChat.id);
        
        showToast('Sprachnachricht gesendet', 'success');
        
    } catch (error) {
        console.error('Error uploading audio:', error);
        showToast('Upload fehlgeschlagen: ' + error.message, 'error');
    }
}

// ===== NACHRICHTEN SENDEN (DEBOUNCED) =====
let isSending = false;

async function sendMessage() {
    if (isSending) return;
    
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    
    if (!text || !currentChat || !currentUser) {
        showToast('Nachricht darf nicht leer sein', 'warning');
        return;
    }
    
    isSending = true;
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = true;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    try {
        const { error } = await window.supabaseClient
            .from('messages')
            .insert({
                chat_id: currentChat.id,
                sender_id: currentUser.id,
                type: 'text',
                content: text,
                created_at: new Date().toISOString()
            });
        
        if (!error) {
            // Update chat
            const shortText = text.length > 50 ? text.substring(0, 47) + '...' : text;
            await window.supabaseClient
                .from('chats')
                .update({
                    last_message: shortText,
                    updated_at: new Date().toISOString(),
                    unread_count: (currentChat.unread_count || 0) + 1
                })
                .eq('id', currentChat.id);
            
            // Clear input
            input.value = '';
            input.style.height = 'auto';
            
            // Reset typing
            isTyping = false;
            clearTimeout(typingTimeout);
            
            showToast('Nachricht gesendet', 'success');
        } else {
            throw error;
        }
    } catch (error) {
        console.error('Error sending message:', error);
        showToast('Fehler beim Senden: ' + error.message, 'error');
    } finally {
        isSending = false;
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
    }
}

// ===== TYPING INDICATOR =====
function setupTypingListener(chatId) {
    if (typingSubscription) {
        typingSubscription.unsubscribe();
    }
    
    typingSubscription = window.supabaseClient
        .channel('typing-' + chatId)
        .on(
            'postgres_changes',
            {
                event: 'UPDATE',
                schema: 'public',
                table: 'chats',
                filter: `id=eq.${chatId}`
            },
            (payload) => {
                const typingUser = payload.new.typing_user;
                
                if (typingUser && typingUser !== currentUser.id) {
                    showTypingIndicator(typingUser);
                    
                    // Hide after 3 seconds
                    setTimeout(() => {
                        hideTypingIndicator();
                    }, 3000);
                } else {
                    hideTypingIndicator();
                }
            }
        )
        .subscribe();
}

function handleTyping() {
    const input = document.getElementById('messageInput');
    
    if (!isTyping && input.value.length > 0) {
        isTyping = true;
        sendTypingStatus(true);
    } else if (isTyping && input.value.length === 0) {
        isTyping = false;
        sendTypingStatus(false);
    }
    
    // Auto-resize textarea
    input.style.height = 'auto';
    input.style.height = Math.min(input.scrollHeight, 120) + 'px';
    
    // Clear previous timeout
    clearTimeout(typingTimeout);
    
    // Set new timeout
    typingTimeout = setTimeout(() => {
        if (isTyping) {
            isTyping = false;
            sendTypingStatus(false);
        }
    }, 2000);
}

async function sendTypingStatus(typing) {
    if (!currentChat) return;
    
    try {
        await window.supabaseClient
            .from('chats')
            .update({
                typing_user: typing ? currentUser.id : null,
                updated_at: new Date().toISOString()
            })
            .eq('id', currentChat.id);
    } catch (error) {
        console.error('Error sending typing status:', error);
    }
}

function showTypingIndicator(userId) {
    const user = users.find(u => u.id === userId);
    if (user && currentChat && userId !== currentUser.id) {
        const displayName = user.display_name || user.email.split('@')[0];
        document.getElementById('typingUser').textContent = displayName;
        document.getElementById('typingIndicator').classList.remove('hidden');
    }
}

function hideTypingIndicator() {
    document.getElementById('typingIndicator').classList.add('hidden');
}

// ===== FILE UPLOAD =====
document.getElementById('fileInput').addEventListener('change', async function(e) {
    const files = e.target.files;
    if (!files.length || !currentChat || !currentUser) {
        showToast('Whle zuerst einen Chat', 'warning');
        return;
    }
    
    for (let file of files) {
        await uploadFile(file);
    }
    
    e.target.value = '';
});

async function uploadFile(file) {
    try {
        const fileType = file.type.startsWith('image/') ? 'image' : 
                        file.type.startsWith('audio/') ? 'audio' : 'file';
        const fileName = file.name;
        const fileSize = file.size;
        
        // Show progress
        const progressId = 'progress-' + Date.now();
        const container = document.getElementById('messagesScroll');
        
        const progressDiv = document.createElement('div');
        progressDiv.id = progressId;
        progressDiv.className = 'upload-progress';
        progressDiv.innerHTML = `
            <div class="progress-info">
                <div class="progress-filename">${escapeHtml(fileName)}</div>
                <div class="progress-percentage">0%</div>
            </div>
            <div class="progress-track">
                <div class="progress-bar" style="width: 0%"></div>
            </div>
        `;
        
        container.appendChild(progressDiv);
        
        // Upload to Supabase Storage
        const fileExt = fileName.split('.').pop();
        const timestamp = Date.now();
        const uniqueName = `${timestamp}-${generateId()}.${fileExt}`;
        const filePath = `chat-${currentChat.id}/${uniqueName}`;
        
        // Simulate progress
        let progress = 0;
        const progressInterval = setInterval(() => {
            if (progress < 90) {
                progress += 10;
                const progressBar = document.querySelector(`#${progressId} .progress-bar`);
                const progressPercent = document.querySelector(`#${progressId} .progress-percentage`);
                if (progressBar && progressPercent) {
                    progressBar.style.width = `${progress}%`;
                    progressPercent.textContent = `${progress}%`;
                }
            }
        }, 200);
        
        const { data, error } = await window.supabaseClient.storage
            .from('files')
            .upload(filePath, file, {
                cacheControl: '3600',
                upsert: false
            });
        
        clearInterval(progressInterval);
        
        if (error) {
            // Try without chat folder if error
            const fallbackPath = `${currentUser.id}/${uniqueName}`;
            const { data: fallbackData, error: fallbackError } = await window.supabaseClient.storage
                .from('files')
                .upload(fallbackPath, file, {
                    cacheControl: '3600',
                    upsert: false
                });
            
            if (fallbackError) throw fallbackError;
        }
        
        // Complete progress
        const progressBar = document.querySelector(`#${progressId} .progress-bar`);
        const progressPercent = document.querySelector(`#${progressId} .progress-percentage`);
        if (progressBar && progressPercent) {
            progressBar.style.width = '100%';
            progressPercent.textContent = '100%';
        }
        
        // Get public URL
        const { data: { publicUrl } } = window.supabaseClient.storage
            .from('files')
            .getPublicUrl(data ? filePath : fallbackPath);
        
        // Save message
        const messageData = {
            chat_id: currentChat.id,
            sender_id: currentUser.id,
            type: fileType,
            content: fileType === 'image' ? ' Bild gesendet' : 
                    fileType === 'audio' ? ' Audio gesendet' : ' Datei gesendet',
            file_url: publicUrl,
            file_name: fileName,
            file_size: fileSize,
            created_at: new Date().toISOString()
        };
        
        await window.supabaseClient
            .from('messages')
            .insert(messageData);
        
        // Update chat
        await window.supabaseClient
            .from('chats')
            .update({
                last_message: fileType === 'image' ? ' Bild' : 
                            fileType === 'audio' ? ' Audio' : ' Datei',
                updated_at: new Date().toISOString()
            })
            .eq('id', currentChat.id);
        
        // Remove progress
        setTimeout(() => {
            const progressElement = document.getElementById(progressId);
            if (progressElement) progressElement.remove();
        }, 1000);
        
        showToast(`${fileType === 'image' ? 'Bild' : 'Datei'} gesendet`, 'success');
        
    } catch (error) {
        console.error('Error uploading file:', error);
        showToast('Upload fehlgeschlagen: ' + error.message, 'error');
        
        // Remove progress on error
        const progressElement = document.getElementById(progressId);
        if (progressElement) progressElement.remove();
    }
}

function showImagePreview(url) {
    document.getElementById('previewImage').src = url;
    showModal('imagePreviewModal');
}

function downloadFile(url, fileName) {
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// ===== EMOJI PICKER =====
function initEmojiPicker() {
    const emojiPicker = document.getElementById('emojiPicker');
    if (!emojiPicker) return;
    
    const emojis = {
        'Smileys': ['', '', '', '', '', '', '', '', '', ''],
        'Gestures': ['', '', '', '', '', '', '', '', '', ''],
        'Objects': ['', '', '', '', '', '', '', '', '', ''],
        'Nature': ['', '', '', '', '', '', '', '', '', ''],
        'Food': ['', '', '', '', '', '', '', '', '', ''],
        'Travel': ['', '', '', '', '', '', '', '', '', '']
    };
    
    let html = '';
    for (const [category, emojiList] of Object.entries(emojis)) {
        html += `
            <div class="emoji-category">
                <div class="emoji-category-title">${category}</div>
                <div class="emoji-grid">
                    ${emojiList.map(emoji => `
                        <div class="emoji" onclick="insertEmoji('${emoji}')">${emoji}</div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    emojiPicker.innerHTML = html;
}

function toggleEmojiPicker() {
    const picker = document.getElementById('emojiPicker');
    if (picker.style.display === 'block') {
        picker.style.display = 'none';
    } else {
        picker.style.display = 'block';
        // Position picker
        const inputArea = document.querySelector('.input-area');
        const rect = inputArea.getBoundingClientRect();
        picker.style.bottom = (window.innerHeight - rect.top + 80) + 'px';
        picker.style.left = '20px';
    }
}

function insertEmoji(emoji) {
    const input = document.getElementById('messageInput');
    const cursorPos = input.selectionStart;
    const textBefore = input.value.substring(0, cursorPos);
    const textAfter = input.value.substring(cursorPos);
    
    input.value = textBefore + emoji + textAfter;
    input.focus();
    input.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
    
    // Trigger typing
    handleTyping();
    
    // Hide picker
    document.getElementById('emojiPicker').style.display = 'none';
}

// Close emoji picker when clicking outside
document.addEventListener('click', function(e) {
    const picker = document.getElementById('emojiPicker');
    const emojiBtn = document.querySelector('.tool-btn[title="Emoji"]');
    
    if (picker && picker.style.display === 'block' && 
        !picker.contains(e.target) && 
        (!emojiBtn || !emojiBtn.contains(e.target))) {
        picker.style.display = 'none';
    }
});

// ===== WEBRTC CALLS =====
async function startCall(type) {
    if (!currentChat) {
        showToast('Whle zuerst einen Chat', 'warning');
        return;
    }
    
    try {
        // Get media stream
        const constraints = {
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            },
            video: type === 'video' ? {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                frameRate: { ideal: 30 }
            } : false
        };
        
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        // Create peer connection
        peerConnection = new RTCPeerConnection(iceServers);
        
        // Add local tracks
        localStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, localStream);
        });
        
        // Setup remote stream
        peerConnection.ontrack = (event) => {
            if (event.streams && event.streams[0]) {
                remoteStream = event.streams[0];
                const remoteVideo = document.getElementById('remoteVideo');
                remoteVideo.srcObject = remoteStream;
            }
        };
        
        // ICE candidates
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                console.log('New ICE candidate:', event.candidate);
            }
        };
        
        peerConnection.oniceconnectionstatechange = () => {
            console.log('ICE connection state:', peerConnection.iceConnectionState);
            if (peerConnection.iceConnectionState === 'disconnected' ||
                peerConnection.iceConnectionState === 'failed') {
                showToast('Verbindung verloren', 'error');
                endCall();
            }
        };
        
        // Create offer
        const offer = await peerConnection.createOffer({
            offerToReceiveAudio: true,
            offerToReceiveVideo: type === 'video'
        });
        
        await peerConnection.setLocalDescription(offer);
        
        // Show call UI
        showCallUI(type, 'Wird verbunden...');
        
        // Simulate incoming call for demo
        setTimeout(() => {
            simulateIncomingCall();
        }, 2000);
        
        showToast('Anruf wird gestartet...', 'info');
        
    } catch (error) {
        console.error('Error starting call:', error);
        showToast('Fehler beim Starten: ' + error.message, 'error');
        
        // Clean up
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
    }
}

function simulateIncomingCall() {
    if (!currentChat) return;
    
    // Find the other participant
    const otherParticipant = currentChat.participants.find(id => id !== currentUser.id);
    if (!otherParticipant) return;
    
    const user = users.find(u => u.id === otherParticipant);
    if (!user) return;
    
    // Show incoming call UI for the other user (simulated)
    const displayName = user.display_name || user.email.split('@')[0];
    document.getElementById('incomingCallName').textContent = displayName;
    document.getElementById('incomingCallType').textContent = 'Videoanruf';
    document.getElementById('incomingCallAvatar').textContent = displayName.charAt(0).toUpperCase();
    
    // Set avatar if exists
    const incomingCallAvatar = document.getElementById('incomingCallAvatar');
    if (user.avatar_url) {
        incomingCallAvatar.style.backgroundImage = `url(${user.avatar_url})`;
        incomingCallAvatar.style.backgroundSize = 'cover';
        incomingCallAvatar.style.backgroundPosition = 'center';
        incomingCallAvatar.textContent = '';
    }
    
    document.getElementById('incomingCall').style.display = 'flex';
}

function acceptCall() {
    document.getElementById('incomingCall').style.display = 'none';
    document.getElementById('callStatus').textContent = 'Verbunden';
    showToast('Anruf angenommen', 'success');
}

function rejectCall() {
    document.getElementById('incomingCall').style.display = 'none';
    showToast('Anruf abgelehnt', 'info');
}

function showCallUI(type, status) {
    const container = document.getElementById('callContainer');
    const title = document.getElementById('callTitle');
    const statusEl = document.getElementById('callStatus');
    
    let contactName = 'Unbekannt';
    if (currentChat.type === 'group') {
        contactName = currentChat.name || 'Gruppenchat';
    } else {
        const partnerId = currentChat.participants.find(id => id !== currentUser.id);
        const partner = users.find(u => u.id === partnerId);
        if (partner) {
            contactName = partner.display_name || partner.email.split('@')[0];
        }
    }
    
    title.textContent = `${type === 'video' ? 'Videoanruf' : 'Sprachanruf'} mit ${contactName}`;
    statusEl.textContent = status;
    
    // Show local video
    if (type === 'video' && localStream) {
        const localVideo = document.getElementById('localVideo');
        localVideo.srcObject = localStream;
    }
    
    container.style.display = 'flex';
    
    // Start call timer
    callStartTime = new Date();
    callTimer = setInterval(updateCallTimer, 1000);
}

function updateCallTimer() {
    if (!callStartTime) return;
    
    const elapsed = Math.floor((new Date() - callStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
    const seconds = (elapsed % 60).toString().padStart(2, '0');
    
    document.getElementById('callDuration').textContent = `${minutes}:${seconds}`;
}

async function endCall() {
    clearInterval(callTimer);
    
    // Stop streams
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    
    if (screenStream) {
        screenStream.getTracks().forEach(track => track.stop());
        screenStream = null;
    }
    
    if (remoteStream) {
        remoteStream.getTracks().forEach(track => track.stop());
        remoteStream = null;
    }
    
    // Close connection
    if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
    }
    
    // Hide call UI
    document.getElementById('callContainer').style.display = 'none';
    
    // Update calls history
    await loadCallsHistory();
    
    showToast('Anruf beendet', 'info');
}

// Call controls
function toggleMute() {
    if (!localStream) return;
    
    const audioTrack = localStream.getAudioTracks()[0];
    if (audioTrack) {
        audioTrack.enabled = !audioTrack.enabled;
        const btn = document.getElementById('muteBtn');
        btn.classList.toggle('muted', !audioTrack.enabled);
        showToast(audioTrack.enabled ? 'Stummschaltung aufgehoben' : 'Stumm geschaltet', 'info');
    }
}

function toggleVideo() {
    if (!localStream) return;
    
    const videoTrack = localStream.getVideoTracks()[0];
    if (videoTrack) {
        videoTrack.enabled = !videoTrack.enabled;
        const btn = document.getElementById('videoBtn');
        btn.classList.toggle('active', !videoTrack.enabled);
        
        const localVideo = document.getElementById('localVideo');
        if (videoTrack.enabled) {
            localVideo.style.opacity = '1';
            showToast('Video eingeschaltet', 'info');
        } else {
            localVideo.style.opacity = '0.5';
            showToast('Video ausgeschaltet', 'info');
        }
    }
}

async function toggleScreenShare() {
    try {
        if (!screenStream) {
            // Start screen share
            screenStream = await navigator.mediaDevices.getDisplayMedia({
                video: {
                    cursor: 'always',
                    displaySurface: 'monitor'
                },
                audio: false
            });
            
            // Replace video track
            const videoTrack = screenStream.getVideoTracks()[0];
            const sender = peerConnection.getSenders().find(s => s.track?.kind === 'video');
            
            if (sender) {
                sender.replaceTrack(videoTrack);
            }
            
            // Update local video
            const localVideo = document.getElementById('localVideo');
            localVideo.srcObject = screenStream;
            
            document.getElementById('screenShareBtn').classList.add('active');
            showToast('Bildschirm teilen aktiv', 'success');
            
            // Handle when user stops sharing
            videoTrack.onended = () => {
                toggleScreenShare();
            };
            
        } else {
            // Stop screen share
            screenStream.getTracks().forEach(track => track.stop());
            screenStream = null;
            
            // Restore camera
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                const sender = peerConnection.getSenders().find(s => s.track?.kind === 'video');
                
                if (sender && videoTrack) {
                    sender.replaceTrack(videoTrack);
                }
                
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = localStream;
            }
            
            document.getElementById('screenShareBtn').classList.remove('active');
            showToast('Bildschirm teilen beendet', 'info');
        }
    } catch (error) {
        console.error('Screen share error:', error);
        showToast('Bildschirm teilen fehlgeschlagen', 'error');
    }
}

function toggleAudioOutput() {
    const remoteVideo = document.getElementById('remoteVideo');
    if (remoteVideo.setSinkId) {
        const speakers = ['default', 'speakers'];
        const currentSpeaker = remoteVideo.sinkId || 'default';
        const nextIndex = (speakers.indexOf(currentSpeaker) + 1) % speakers.length;
        
        remoteVideo.setSinkId(speakers[nextIndex])
            .then(() => {
                showToast(`Audioausgabe: ${speakers[nextIndex]}`, 'info');
            })
            .catch(console.error);
    }
}

function toggleRecording() {
    const btn = document.getElementById('recordBtn');
    btn.classList.toggle('recording');
    
    if (btn.classList.contains('recording')) {
        showToast('Aufnahme gestartet', 'info');
    } else {
        showToast('Aufnahme gestoppt', 'info');
    }
}

function toggleParticipants() {
    const panel = document.getElementById('participantsPanel');
    panel.classList.toggle('hidden');
}

function toggleFullscreen() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(console.log);
    } else {
        document.exitFullscreen().catch(console.log);
    }
}

// ===== GRUPPEN EINSTELLUNGEN =====
function showChatSettings() {
    if (!currentChat) {
        showToast('Whle zuerst einen Chat', 'warning');
        return;
    }
    
    if (currentChat.type === 'group') {
        showGroupSettings();
    } else {
        const contactName = document.getElementById('contactName').textContent;
        alert(`Chat mit ${contactName}\n\nHier knnen spter weitere Einstellungen hinzugefgt werden.`);
    }
}

async function showGroupSettings() {
    if (!currentChat || currentChat.type !== 'group') return;
    
    // Load group members with roles
    const members = currentChat.participants || [];
    
    document.getElementById('groupSettingsSubtitle').textContent = currentChat.name;
    document.getElementById('editGroupName').value = currentChat.name || '';
    document.getElementById('editGroupDescription').value = currentChat.description || '';
    
    const membersContainer = document.getElementById('groupMembersSettings');
    membersContainer.innerHTML = '';
    
    members.forEach(memberId => {
        const user = users.find(u => u.id === memberId);
        if (!user) return;
        
        const displayName = user.display_name || user.email.split('@')[0];
        const isAdmin = currentChat.created_by === memberId;
        const isCurrentUser = memberId === currentUser.id;
        
        const memberDiv = document.createElement('div');
        memberDiv.className = 'group-member-item';
        
        memberDiv.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="avatar" style="width: 40px; height: 40px;">
                    ${displayName.charAt(0).toUpperCase()}
                </div>
                <div>
                    <div class="font-medium">${escapeHtml(displayName)}</div>
                    <div class="text-sm text-gray-400">${user.email}</div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                ${isAdmin ? '<span class="admin-badge">Admin</span>' : ''}
                ${!isCurrentUser && currentChat.created_by === currentUser.id ? `
                    <button class="btn btn-sm btn-danger" onclick="removeGroupMember('${memberId}')">
                        <i class="fas fa-times"></i>
                    </button>
                ` : ''}
            </div>
        `;
        
        membersContainer.appendChild(memberDiv);
    });
    
    showModal('groupSettingsModal');
}

async function saveGroupSettings() {
    const name = document.getElementById('editGroupName').value.trim();
    const description = document.getElementById('editGroupDescription').value.trim();
    
    if (!name) {
        showToast('Gruppenname darf nicht leer sein', 'error');
        return;
    }
    
    try {
        await window.supabaseClient
            .from('chats')
            .update({
                name,
                description,
                updated_at: new Date().toISOString()
            })
            .eq('id', currentChat.id);
        
        // Update local state
        currentChat.name = name;
        currentChat.description = description;
        
        updateChatHeader(currentChat);
        updateChatsList();
        
        closeModal('groupSettingsModal');
        showToast('Gruppeneinstellungen gespeichert', 'success');
        
    } catch (error) {
        console.error('Error saving group settings:', error);
        showToast('Fehler beim Speichern', 'error');
    }
}

function showAddMemberModal() {
    const container = document.getElementById('availableContactsList');
    container.innerHTML = '';
    
    // Show contacts that are not already in the group
    const existingMembers = currentChat.participants || [];
    const availableContacts = contacts.filter(contactId => 
        !existingMembers.includes(contactId)
    );
    
    if (availableContacts.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-500 py-4">Keine weiteren Kontakte verfgbar</div>';
        return;
    }
    
    availableContacts.forEach(contactId => {
        const user = users.find(u => u.id === contactId);
        if (!user) return;
        
        const displayName = user.display_name || user.email.split('@')[0];
        
        const contactDiv = document.createElement('label');
        contactDiv.className = 'flex items-center gap-3 p-3 hover:bg-gray-800 rounded-lg cursor-pointer';
        contactDiv.innerHTML = `
            <input type="checkbox" value="${contactId}" class="rounded">
            <div class="avatar" style="width: 40px; height: 40px;">
                ${displayName.charAt(0).toUpperCase()}
            </div>
            <div>
                <div class="font-medium">${escapeHtml(displayName)}</div>
                <div class="text-sm text-gray-400">${user.email}</div>
            </div>
        `;
        
        container.appendChild(contactDiv);
    });
    
    showModal('addMemberModal');
}

async function addMembersToGroup() {
    const selected = Array.from(document.querySelectorAll('#availableContactsList input:checked'))
        .map(input => input.value);
    
    if (selected.length === 0) {
        showToast('Keine Mitglieder ausgewhlt', 'warning');
        return;
    }
    
    try {
        // Add to participants
        const newParticipants = [...currentChat.participants, ...selected];
        
        await window.supabaseClient
            .from('chats')
            .update({
                participants: newParticipants,
                updated_at: new Date().toISOString()
            })
            .eq('id', currentChat.id);
        
        // Update local state
        currentChat.participants = newParticipants;
        
        // Add system message
        const addedNames = selected.map(id => {
            const user = users.find(u => u.id === id);
            return user?.display_name || user?.email.split('@')[0] || 'Unbekannt';
        }).join(', ');
        
        await window.supabaseClient
            .from('messages')
            .insert({
                chat_id: currentChat.id,
                sender_id: currentUser.id,
                type: 'system',
                content: `${addedNames} wurde(n) zur Gruppe hinzugefgt.`,
                created_at: new Date().toISOString()
            });
        
        closeModal('addMemberModal');
        showToast('Mitglieder hinzugefgt', 'success');
        
        // Refresh chat
        await loadMessages(currentChat.id);
        
    } catch (error) {
        console.error('Error adding members:', error);
        showToast('Fehler beim Hinzufgen', 'error');
    }
}

async function removeGroupMember(memberId) {
    if (!confirm('Mitglied wirklich entfernen?')) return;
    
    try {
        // Remove from participants
        const newParticipants = currentChat.participants.filter(id => id !== memberId);
        
        await window.supabaseClient
            .from('chats')
            .update({
                participants: newParticipants,
                updated_at: new Date().toISOString()
            })
            .eq('id', currentChat.id);
        
        // Update local state
        currentChat.participants = newParticipants;
        
        // Add system message
        const removedUser = users.find(u => u.id === memberId);
        const removedName = removedUser?.display_name || removedUser?.email.split('@')[0] || 'Unbekannt';
        
        await window.supabaseClient
            .from('messages')
            .insert({
                chat_id: currentChat.id,
                sender_id: currentUser.id,
                type: 'system',
                content: `${removedName} wurde aus der Gruppe entfernt.`,
                created_at: new Date().toISOString()
            });
        
        showToast('Mitglied entfernt', 'success');
        
        // Refresh settings
        showGroupSettings();
        
    } catch (error) {
        console.error('Error removing member:', error);
        showToast('Fehler beim Entfernen', 'error');
    }
}

async function leaveGroup() {
    if (!confirm('Gruppe wirklich verlassen?')) return;
    
    try {
        // Remove current user from participants
        const newParticipants = currentChat.participants.filter(id => id !== currentUser.id);
        
        await window.supabaseClient
            .from('chats')
            .update({
                participants: newParticipants,
                updated_at: new Date().toISOString()
            })
            .eq('id', currentChat.id);
        
        // Add system message
        await window.supabaseClient
            .from('messages')
            .insert({
                chat_id: currentChat.id,
                sender_id: currentUser.id,
                type: 'system',
                content: `${currentUser.email.split('@')[0]} hat die Gruppe verlassen.`,
                created_at: new Date().toISOString()
            });
        
        // Remove chat from local list
        chats = chats.filter(chat => chat.id !== currentChat.id);
        currentChat = null;
        
        updateChatsList();
        closeModal('groupSettingsModal');
        
        showToast('Gruppe verlassen', 'success');
        
    } catch (error) {
        console.error('Error leaving group:', error);
        showToast('Fehler beim Verlassen', 'error');
    }
}

// ===== UMFRAGEN =====
function showPollModal() {
    showModal('pollModal');
}

function addPollOption() {
    const container = document.getElementById('pollOptions');
    const optionCount = container.children.length + 1;
    
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = `
        <input type="text" class="form-input poll-option" placeholder="Option ${optionCount}">
    `;
    
    container.appendChild(div);
}

async function createPoll() {
    const question = document.getElementById('pollQuestion').value.trim();
    const options = Array.from(document.querySelectorAll('.poll-option'))
        .map(input => input.value.trim())
        .filter(text => text.length > 0);
    
    const isAnonymous = document.getElementById('pollAnonymous').checked;
    const isMultiple = document.getElementById('pollMultiple').checked;
    
    if (!question) {
        showToast('Bitte eine Frage eingeben', 'error');
        return;
    }
    
    if (options.length < 2) {
        showToast('Mindestens 2 Optionen bentigt', 'error');
        return;
    }
    
    try {
        const pollData = {
            question,
            options: options.map(text => ({ text, votes: 0 })),
            anonymous: isAnonymous,
            multiple: isMultiple,
            voters: [],
            user_votes: {}
        };
        
        await window.supabaseClient
            .from('messages')
            .insert({
                chat_id: currentChat.id,
                sender_id: currentUser.id,
                type: 'poll',
                content: ' Umfrage',
                poll_data: pollData,
                created_at: new Date().toISOString()
            });
        
        // Update chat
        await window.supabaseClient
            .from('chats')
            .update({
                last_message: ' Umfrage',
                updated_at: new Date().toISOString()
            })
            .eq('id', currentChat.id);
        
        closeModal('pollModal');
        showToast('Umfrage erstellt', 'success');
        
        // Reset form
        document.getElementById('pollQuestion').value = '';
        document.querySelectorAll('.poll-option').forEach(input => input.value = '');
        
    } catch (error) {
        console.error('Error creating poll:', error);
        showToast('Fehler beim Erstellen: ' + error.message, 'error');
    }
}

function renderPoll(message) {
    const pollData = message.poll_data || {};
    const totalVotes = pollData.options?.reduce((sum, opt) => sum + (opt.votes || 0), 0) || 0;
    const userVoted = pollData.voters?.includes(currentUser.id) || false;
    
    let optionsHTML = '';
    
    if (pollData.options) {
        pollData.options.forEach((option, index) => {
            const percentage = totalVotes > 0 ? Math.round((option.votes || 0) / totalVotes * 100) : 0;
            const isSelected = pollData.user_votes?.[currentUser.id]?.includes(index);
            
            optionsHTML += `
                <div class="poll-option ${userVoted && isSelected ? 'selected' : ''}" 
                     onclick="${!userVoted || pollData.multiple ? `voteOnPoll('${message.id}', ${index})` : ''}">
                    <div class="poll-option-header">
                        <div class="poll-text">${escapeHtml(option.text)}</div>
                        <div class="poll-percentage">${percentage}%</div>
                    </div>
                    <div class="poll-votes">${option.votes || 0} Stimmen</div>
                    <div class="poll-bar-container">
                        <div class="poll-bar" style="width: ${percentage}%"></div>
                    </div>
                </div>
            `;
        });
    }
    
    return `
        <div class="poll-container">
            <div class="poll-question">${escapeHtml(pollData.question)}</div>
            ${optionsHTML}
            <div class="poll-footer">
                <span>${totalVotes} Stimmen</span>
                <span>${pollData.anonymous ? 'Anonym' : 'Nicht anonym'}</span>
                <span>${pollData.multiple ? 'Mehrfachauswahl' : 'Einzelauswahl'}</span>
                <span>${userVoted ? ' Abgestimmt' : 'Noch nicht abgestimmt'}</span>
            </div>
        </div>
    `;
}

async function voteOnPoll(messageId, optionIndex) {
    try {
        // Get current poll
        const { data: message } = await window.supabaseClient
            .from('messages')
            .select('*')
            .eq('id', messageId)
            .single();
        
        if (!message) return;
        
        const pollData = message.poll_data || {};
        
        // Check if user already voted (for single choice polls)
        if (pollData.voters?.includes(currentUser.id) && !pollData.multiple) {
            showToast('Du hast bereits abgestimmt', 'warning');
            return;
        }
        
        // Add vote
        if (!pollData.options[optionIndex].votes) {
            pollData.options[optionIndex].votes = 0;
        }
        pollData.options[optionIndex].votes += 1;
        
        // Update voter list
        if (!pollData.voters) pollData.voters = [];
        if (!pollData.voters.includes(currentUser.id)) {
            pollData.voters.push(currentUser.id);
        }
        
        // Update user votes
        if (!pollData.user_votes) pollData.user_votes = {};
        if (!pollData.user_votes[currentUser.id]) {
            pollData.user_votes[currentUser.id] = [];
        }
        if (!pollData.user_votes[currentUser.id].includes(optionIndex)) {
            pollData.user_votes[currentUser.id].push(optionIndex);
        }
        
        // Update in database
        await window.supabaseClient
            .from('messages')
            .update({ poll_data: pollData })
            .eq('id', messageId);
        
        // Reload message to show updated poll
        await loadMessages(currentChat.id);
        
        showToast('Abgestimmt!', 'success');
        
    } catch (error) {
        console.error('Error voting:', error);
        showToast('Fehler beim Abstimmen: ' + error.message, 'error');
    }
}

// ===== EVENT LISTENERS =====
document.addEventListener('DOMContentLoaded', function() {
    // Login form
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    
    // Quick login buttons
    document.getElementById('quickLogin1').addEventListener('click', () => quickLogin(1));
    document.getElementById('quickLogin2').addEventListener('click', () => quickLogin(2));
    document.getElementById('quickLogin3').addEventListener('click', () => quickLogin(3));
    
    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            
            // Update active tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
            
            this.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            
            // Update search based on active tab
            const searchTerm = document.getElementById('searchInput').value;
            if (searchTerm) {
                performSearch(searchTerm);
            }
        });
    });
    
    // Send message
    document.getElementById('sendButton').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Auto-resize textarea
    document.getElementById('messageInput').addEventListener('input', handleTyping);
    
    // Mobile menu
    document.getElementById('mobileMenuBtn').addEventListener('click', function() {
        document.getElementById('sidebar').classList.toggle('active');
    });
    
    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(e) {
        if (window.innerWidth <= 768) {
            const sidebar = document.getElementById('sidebar');
            const menuBtn = document.getElementById('mobileMenuBtn');
            
            if (sidebar.classList.contains('active') && 
                !sidebar.contains(e.target) && 
                !menuBtn.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        }
    });
    
    // Auto login if session exists
    window.supabaseClient.auth.getSession().then(({ data: { session } }) => {
        if (session) {
            currentUser = session.user;
            initializeUser();
        }
    });
    
    // Auth state change
    window.supabaseClient.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_OUT') {
            currentUser = null;
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mobileMenuBtn').classList.add('hidden');
        } else if (event === 'SIGNED_IN' && session) {
            currentUser = session.user;
            initializeUser();
        }
    });
    
    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
    
    // Close modals on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal').forEach(modal => {
                if (modal.style.display === 'flex') {
                    modal.style.display = 'none';
                }
            });
            document.getElementById('emojiPicker').style.display = 'none';
            document.getElementById('voiceRecordingOverlay').classList.add('hidden');
        }
    });
    
    // Window resize handling
    window.addEventListener('resize', function() {
        if (window.innerWidth <= 768) {
            document.getElementById('mobileMenuBtn').classList.remove('hidden');
        } else {
            document.getElementById('mobileMenuBtn').classList.add('hidden');
            document.getElementById('sidebar').classList.remove('active');
        }
    });
    
    // Initialize mobile button visibility
    if (window.innerWidth <= 768) {
        document.getElementById('mobileMenuBtn').classList.remove('hidden');
    }
    
    // Touch gestures for mobile
    let startX = 0;
    let startY = 0;
    
    document.addEventListener('touchstart', function(e) {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
    }, { passive: true });
    
    document.addEventListener('touchend', function(e) {
        if (!startX || !startY) return;
        
        const endX = e.changedTouches[0].clientX;
        const endY = e.changedTouches[0].clientY;
        
        const diffX = endX - startX;
        const diffY = endY - startY;
        
        // Horizontal swipe (for sidebar on mobile)
        if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
            if (window.innerWidth <= 768) {
                if (diffX > 0) {
                    // Swipe right - open sidebar
                    document.getElementById('sidebar').classList.add('active');
                } else {
                    // Swipe left - close sidebar
                    document.getElementById('sidebar').classList.remove('active');
                }
            }
        }
        
        startX = 0;
        startY = 0;
    }, { passive: true });
});

// ===== SUCHFUNKTION =====
let searchTimeout = null;

document.getElementById('searchInput').addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    
    searchTimeout = setTimeout(() => {
        const searchTerm = e.target.value.toLowerCase().trim();
        performSearch(searchTerm);
    }, 300);
});

async function performSearch(searchTerm) {
    const activeTab = document.querySelector('.tab.active')?.dataset.tab;
    if (!activeTab) return;
    
    if (!searchTerm) {
        // Show all if search is empty
        switch(activeTab) {
            case 'chats': updateChatsList(); break;
            case 'contacts': updateContactsList(); break;
            case 'groups': updateGroupsList(); break;
        }
        return;
    }
    
    try {
        switch(activeTab) {
            case 'chats':
                await searchChats(searchTerm);
                break;
            case 'contacts':
                await searchContacts(searchTerm);
                break;
            case 'groups':
                await searchGroups(searchTerm);
                break;
        }
    } catch (error) {
        console.error('Search error:', error);
    }
}

async function searchContacts(searchTerm) {
    const container = document.getElementById('contactsList');
    const emptyState = document.getElementById('contactsEmpty');
    
    container.innerHTML = '';
    
    try {
        // Search contacts
        const contactIds = contacts.filter(contactId => {
            const user = users.find(u => u.id === contactId);
            if (!user) return false;
            
            const displayName = user.display_name || user.email.split('@')[0];
            return displayName.toLowerCase().includes(searchTerm) || 
                   user.email.toLowerCase().includes(searchTerm);
        });
        
        if (contactIds.length === 0) {
            emptyState.classList.remove('hidden');
            return;
        }
        
        emptyState.classList.add('hidden');
        
        // Show matching contacts
        contactIds.forEach(contactId => {
            const user = users.find(u => u.id === contactId);
            if (user) {
                const contactElement = createContactElement(user);
                container.appendChild(contactElement);
            }
        });
        
    } catch (error) {
        console.error('Search error:', error);
        emptyState.classList.remove('hidden');
    }
}

// ===== GLOBALE FUNKTIONEN =====
function showProfileModal() {
    showModal('profileModal');
}

function showAddContactModal() {
    showModal('addContactModal');
}

async function startChatWithContact(contactId) {
    try {
        // Check if chat already exists
        const existingChat = chats.find(chat => 
            chat.type === 'private' && 
            chat.participants.includes(contactId) && 
            chat.participants.includes(currentUser.id)
        );
        
        if (existingChat) {
            selectChat(existingChat);
            return;
        }
        
        // Create new chat
        const { data: chat } = await window.supabaseClient
            .from('chats')
            .insert({
                type: 'private',
                participants: [currentUser.id, contactId],
                last_message: '',
                unread_count: 0,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            })
            .select()
            .single();
        
        if (chat) {
            chats.unshift(chat);
            updateChatsList();
            selectChat(chat);
            showToast('Neuer Chat gestartet', 'success');
        }
        
    } catch (error) {
        console.error('Error starting chat:', error);
        showToast('Fehler beim Starten des Chats: ' + error.message, 'error');
    }
}

function startVideoCall() {
    if (!currentChat) {
        showToast('Whle zuerst einen Chat', 'warning');
        return;
    }
    startCall('video');
}

function startVoiceCall() {
    if (!currentChat) {
        showToast('Whle zuerst einen Chat', 'warning');
        return;
    }
    startCall('voice');
}

function startCallWithContact(userId, type) {
    // Find or create chat with this user
    const existingChat = chats.find(chat => 
        chat.type === 'private' && 
        chat.participants.includes(userId) && 
        chat.participants.includes(currentUser.id)
    );
    
    if (existingChat) {
        currentChat = existingChat;
        updateChatHeader(currentChat);
        startCall(type);
    } else {
        // Create temp chat for the call
        currentChat = {
            id: 'temp-call-' + generateId(),
            type: 'private',
            participants: [currentUser.id, userId],
            name: 'Anruf'
        };
        startCall(type);
    }
}

function showCreateGroupModal() {
    const container = document.getElementById('groupMembersList');
    container.innerHTML = '';
    
    // Add contacts to selection
    contacts.forEach(contactId => {
        const contact = users.find(u => u.id === contactId);
        if (contact) {
            const div = document.createElement('label');
            div.className = 'flex items-center gap-3 p-2 hover:bg-gray-800 rounded cursor-pointer mb-2';
            div.innerHTML = `
                <input type="checkbox" value="${contact.id}" class="rounded">
                <div class="flex items-center gap-2">
                    <div class="avatar" style="width: 32px; height: 32px; font-size: 14px;">
                        ${contact.display_name?.charAt(0) || '?'}
                    </div>
                    <span>${escapeHtml(contact.display_name || contact.email.split('@')[0])}</span>
                </div>
            `;
            container.appendChild(div);
        }
    });
    
    showModal('createGroupModal');
}

async function createGroup() {
    const name = document.getElementById('groupName').value.trim();
    const selected = Array.from(document.querySelectorAll('#groupMembersList input:checked'))
        .map(input => input.value);
    
    if (!name) {
        showToast('Gruppenname eingeben', 'error');
        return;
    }
    
    if (selected.length === 0) {
        showToast('Mindestens ein Mitglied auswhlen', 'error');
        return;
    }
    
    try {
        const participants = [currentUser.id, ...selected];
        
        const { data: group } = await window.supabaseClient
            .from('chats')
            .insert({
                type: 'group',
                name,
                participants,
                created_by: currentUser.id,
                last_message: '',
                unread_count: 0,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            })
            .select()
            .single();
        
        if (group) {
            // Add system message
            await window.supabaseClient
                .from('messages')
                .insert({
                    chat_id: group.id,
                    sender_id: currentUser.id,
                    type: 'system',
                    content: `${currentUser.email.split('@')[0]} hat die Gruppe erstellt.`,
                    created_at: new Date().toISOString()
                });
            
            // Update UI
            chats.unshift(group);
            updateChatsList();
            selectChat(group);
            
            closeModal('createGroupModal');
            showToast('Gruppe erstellt', 'success');
            
            // Reset form
            document.getElementById('groupName').value = '';
            document.getElementById('groupMembersList').innerHTML = '';
        }
        
    } catch (error) {
        console.error('Error creating group:', error);
        showToast('Fehler beim Erstellen: ' + error.message, 'error');
    }
}

// ===== GROUPS LIST =====
function updateGroupsList() {
    const container = document.getElementById('groupsList');
    const emptyState = document.getElementById('groupsEmpty');
    
    container.innerHTML = '';
    
    const groupChats = chats.filter(chat => chat.type === 'group');
    
    if (groupChats.length === 0) {
        emptyState.classList.remove('hidden');
        return;
    }
    
    emptyState.classList.add('hidden');
    
    groupChats.forEach(chat => {
        const groupElement = createGroupElement(chat);
        container.appendChild(groupElement);
    });
}

function createGroupElement(chat) {
    const div = document.createElement('div');
    div.className = 'chat-item';
    div.onclick = () => selectChat(chat);
    
    const chatName = chat.name || 'Gruppenchat';
    const memberCount = chat.participants?.length || 0;
    
    div.innerHTML = `
        <div class="chat-avatar" style="background: linear-gradient(135deg, #6a11cb, #2575fc);">
            <i class="fas fa-users"></i>
        </div>
        <div class="chat-info">
            <div class="chat-header">
                <div class="chat-name">${escapeHtml(chatName)}</div>
                <div class="chat-time">${formatTime(chat.updated_at)}</div>
            </div>
            <div class="chat-preview">
                <div class="chat-message">${memberCount} Mitglieder  ${chat.last_message || 'Keine Nachrichten'}</div>
            </div>
        </div>
    `;
    
    return div;
}

// ===== CALLS HISTORY =====
async function loadCallsHistory() {
    try {
        // For demo, we'll create some sample calls
        calls = [
            {
                id: '1',
                type: 'voice',
                status: 'ended',
                duration: 120,
                created_at: new Date(Date.now() - 3600000).toISOString()
            },
            {
                id: '2',
                type: 'video',
                status: 'ended',
                duration: 300,
                created_at: new Date(Date.now() - 86400000).toISOString()
            }
        ];
        
        updateCallsList();
        
    } catch (error) {
        console.error('Error loading calls:', error);
        calls = [];
    }
}

function updateCallsList() {
    const container = document.getElementById('callsList');
    const emptyState = document.getElementById('callsEmpty');
    
    container.innerHTML = '';
    
    if (calls.length === 0) {
        emptyState.classList.remove('hidden');
        return;
    }
    
    emptyState.classList.add('hidden');
    
    calls.forEach(call => {
        const div = document.createElement('div');
        div.className = 'chat-item';
        
        const duration = call.duration ? 
            `${Math.floor(call.duration / 60)}:${(call.duration % 60).toString().padStart(2, '0')}` : 
            '--:--';
        
        const typeIcon = call.type === 'video' ? 'fas fa-video' : 'fas fa-phone';
        const statusColor = call.status === 'ended' ? '#00a884' : 
                           call.status === 'missed' ? '#ff3b30' : '#ff9500';
        const statusText = call.status === 'ended' ? 'Beendet' :
                          call.status === 'missed' ? 'Verpasst' : 'Angenommen';
        
        div.innerHTML = `
            <div class="chat-avatar" style="background: ${statusColor};">
                <i class="${typeIcon}"></i>
            </div>
            <div class="chat-info">
                <div class="chat-header">
                    <div class="chat-name">${call.type === 'video' ? 'Videoanruf' : 'Sprachanruf'}</div>
                    <div class="chat-time">${formatDate(call.created_at)}</div>
                </div>
                <div class="chat-preview">
                    <div class="chat-message">Dauer: ${duration}  ${statusText}</div>
                </div>
            </div>
        `;
        
        container.appendChild(div);
    });
}

// ===== REAL-TIME LISTENERS =====
function setupRealtimeListeners() {
    // Listen for profile updates
    window.supabaseClient
        .channel('profiles')
        .on(
            'postgres_changes',
            {
                event: 'UPDATE',
                schema: 'public',
                table: 'profiles'
            },
            (payload) => {
                // Update user in local list
                const userIndex = users.findIndex(u => u.id === payload.new.id);
                if (userIndex !== -1) {
                    users[userIndex] = { ...users[userIndex], ...payload.new };
                }
                
                // If this is the current user, update UI
                if (payload.new.id === currentUser.id) {
                    updateProfileUI(payload.new);
                }
                
                // Update contacts list if open
                const activeTab = document.querySelector('.tab.active');
                if (activeTab && activeTab.dataset.tab === 'contacts') {
                    updateContactsList();
                }
                
                // Update chat headers if this user is in current chat
                if (currentChat && currentChat.participants.includes(payload.new.id)) {
                    updateChatHeader(currentChat);
                }
            }
        )
        .subscribe();
        
    // Add more listeners as needed
}

// Make functions globally available
window.voteOnPoll = voteOnPoll;
window.insertEmoji = insertEmoji;
window.toggleEmojiPicker = toggleEmojiPicker;
window.showImagePreview = showImagePreview;
window.downloadFile = downloadFile;
window.stopVoiceRecording = stopVoiceRecording;
window.cancelVoiceRecording = cancelVoiceRecording;
window.deleteMessage = deleteMessage;
window.showGroupSettings = showGroupSettings;
window.addContact = addContact;
window.startVoiceMessage = startVoiceMessage;
window.startCallWithContact = startCallWithContact;
window.startVideoCall = startVideoCall;
window.startVoiceCall = startVoiceCall;
window.showCreateGroupModal = showCreateGroupModal;
window.createGroup = createGroup;
window.showPollModal = showPollModal;
window.addPollOption = addPollOption;
window.createPoll = createPoll;
window.showProfileModal = showProfileModal;
window.showAddContactModal = showAddContactModal;
window.startChatWithContact = startChatWithContact;
window.acceptCall = acceptCall;
window.rejectCall = rejectCall;

// Initialisiere die App, wenn DOM geladen ist
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        console.log('WebChat Pro initialisiert');
    });
} else {
    console.log('WebChat Pro initialisiert');
}

// FEHLERBEHEBUNG: Stelle sicher, dass alle Funktionen definiert sind
(function() {
    // Wichtige Funktionen definieren, falls sie fehlen
    if (typeof escapeHtml === 'undefined') {
        window.escapeHtml = function(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };
    }
    
    if (typeof showToast === 'undefined') {
        window.showToast = function(message, type = 'success', duration = 3000) {
            console.log(`[Toast ${type}]: ${message}`);
        };
    }
    
    // Global error handler fr ungefangene Promise-Fehler
    window.addEventListener('unhandledrejection', function(event) {
        console.error('Unhandled promise rejection:', event.reason);
        if (typeof showToast !== 'undefined') {
            showToast('Ein unerwarteter Fehler ist aufgetreten', 'error');
        }
    });
    
    // Global error handler fr ungefangene Exceptions
    window.addEventListener('error', function(event) {
        console.error('Global error:', event.error);
        if (typeof showToast !== 'undefined') {
            showToast('Ein Fehler ist aufgetreten: ' + event.message, 'error');
        }
    });
    
    console.log('WebChat Pro Setup abgeschlossen');
})();

// Event-Listener fr das Senden von Nachrichten mit Enter-Taste
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && e.ctrlKey) {
        e.preventDefault();
        if (typeof sendMessage === 'function') {
            sendMessage();
        }
    }
});

// Wenn jemand versucht, eine nicht definierte Funktion aufzurufen
window.onerror = function(message, source, lineno, colno, error) {
    console.error('JavaScript Fehler:', message, 'in', source, 'Zeile:', lineno);
    return true;
};

</script>

</body>
</html>
